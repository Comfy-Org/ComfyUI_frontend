/api/billing/status:
  get:
    tags:
      - billing
    summary: Get billing status
    description: |
      Returns the current billing status for the workspace.
      Requires workspace-scoped authentication.
    operationId: getBillingStatus
    security:
      - BearerAuth: []
    responses:
      '200':
        description: Billing status
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BillingStatusResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '404':
        description: Workspace not found
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/balance:
  get:
    tags:
      - billing
    summary: Get credit balance
    description: |
      Returns the current credit balance for the workspace from Metronome.
      This is a GET endpoint that may occasionally write (to update has_funds status).
    operationId: getBillingBalance
    security:
      - BearerAuth: []
    responses:
      '200':
        description: Credit balance
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BillingBalanceResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/events:
  get:
    tags:
      - billing
    summary: Get billing events
    description: |
      Returns paginated billing events for the workspace.
      Events include subscription changes, payments, and credit adjustments.
    operationId: getBillingEvents
    security:
      - BearerAuth: []
    parameters:
      - name: page
        in: query
        schema:
          type: integer
          minimum: 1
          default: 1
        description: Page number (1-indexed)
      - name: limit
        in: query
        schema:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
        description: Number of events per page
    responses:
      '200':
        description: Paginated billing events
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BillingEventsResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/plans:
  get:
    tags:
      - billing
    summary: Get available subscription plans
    description: |
      Returns all subscription plans with pricing and availability for the workspace.
      Availability indicates whether the workspace can subscribe to each plan.
    operationId: getBillingPlans
    security:
      - BearerAuth: []
    responses:
      '200':
        description: Available plans with pricing
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BillingPlansResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/preview-subscribe:
  post:
    tags:
      - billing
    summary: Preview what will happen when subscribing to a plan
    description: |
      Returns a preview of the subscription transition including:
      - Cost to charge today (for upgrades/new subscriptions)
      - Cost at next billing period
      - Credits granted today (prorated for upgrades)
      - Credits granted at next billing period

      This endpoint does not execute any billing operations.
      Use it to show the user what will happen before they confirm.
    operationId: previewSubscribe
    security:
      - BearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/PreviewSubscribeRequest'
    responses:
      '200':
        description: Subscription preview
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PreviewSubscribeResponse'
      '400':
        description: Invalid request (e.g., invalid plan slug, seats below minimum)
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/subscribe:
  post:
    tags:
      - billing
    summary: Subscribe to a billing plan
    description: |
      Subscribes the workspace to the specified plan. Flow depends on payment method:

      **If workspace has payment method:**
      - Creates subscription immediately
      - Returns status="subscribed" with effective_at timestamp

      **If workspace needs payment method:**
      - Creates scheduled subscription (status=scheduled)
      - Returns status="needs_payment_method" with payment_method_url
      - After payment method is added via checkout, subscription is finalized

      For existing subscriptions, this performs a plan change (upgrade/downgrade).
    operationId: subscribe
    security:
      - BearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SubscribeRequest'
    responses:
      '200':
        description: Subscription created or payment method needed
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubscribeResponse'
      '400':
        description: Invalid request (e.g., invalid plan slug, incompatible plan)
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/subscription/cancel:
  post:
    tags:
      - billing
    summary: Cancel the current subscription
    description: |
      Cancels the workspace's active subscription at the end of the current billing period.
      The subscription remains active until the period ends, then transitions to ended.

      Returns the date when the subscription will end.
    operationId: cancelSubscription
    security:
      - BearerAuth: []
    responses:
      '200':
        description: Subscription cancellation scheduled
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelSubscriptionResponse'
      '400':
        description: Invalid request (e.g., no active subscription)
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/subscription/resubscribe:
  post:
    tags:
      - billing
    summary: Resubscribe (undo cancel) before period ends
    description: |
      Reverses a scheduled subscription cancellation before the period ends.
      If the subscription has a cancel_at date set (scheduled to cancel at period end),
      this clears the cancellation and resumes the subscription.

      This operation:
      1. Clears the cancel_at date on the subscription
      2. Sets subscription status back to active
      3. Clears the ending_before on the Metronome recurring commit

      Can only be called while the subscription is still in the cancellation grace period
      (before the period ends). After period end, you must subscribe again.
    operationId: resubscribe
    security:
      - BearerAuth: []
    responses:
      '200':
        description: Subscription resumed successfully
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResubscribeResponse'
      '400':
        description: Invalid request (e.g., no active subscription, not in cancellation grace period)
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/payment-portal:
  post:
    tags:
      - billing
    summary: Get payment portal URL
    description: |
      Returns a Stripe Billing Portal URL for managing payment methods.
      The user can add, update, or remove payment methods in the portal.
    operationId: getPaymentPortal
    security:
      - BearerAuth: []
    requestBody:
      required: false
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/PaymentPortalRequest'
    responses:
      '200':
        description: Success
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentPortalResponse'
      '400':
        description: Bad request (e.g., missing return_url)
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/webhooks/stripe:
  post:
    tags:
      - billing
    summary: Stripe webhook endpoint
    description: |
      Receives billing events from Stripe.
      Signature is verified using the Stripe-Signature header.

      Handled events:
      - invoice.paid: Sets billing_status='paid'
    operationId: handleStripeWebhook
    security: []
    parameters:
      - name: Stripe-Signature
        in: header
        required: true
        description: Stripe webhook signature containing timestamp and signatures (t=...,v1=...,v0=...)
        schema:
          type: string
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            description: Stripe webhook event payload
    responses:
      '200':
        description: Webhook processed successfully
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  example: ok
      '400':
        description: Invalid request body
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '401':
        description: Invalid or missing signature
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/webhooks/metronome:
  post:
    tags:
      - billing
    summary: Metronome webhook endpoint
    description: |
      Receives billing events from Metronome.
      Signature is verified using HMAC-SHA256 with the Metronome-Webhook-Signature header.

      Handled events:
      - alerts.low_remaining_commit_balance_reached: Sets has_funds=false
    operationId: handleMetronomeWebhook
    security: []
    parameters:
      - name: Metronome-Webhook-Signature
        in: header
        required: true
        description: HMAC-SHA256 signature of the webhook payload
        schema:
          type: string
      - name: Date
        in: header
        required: true
        description: RFC 1123 formatted timestamp of the request
        schema:
          type: string
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            description: Metronome webhook event payload (schema varies by event type)
            additionalProperties: true
    responses:
      '200':
        description: Webhook processed successfully
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  example: ok
      '400':
        description: Invalid request body
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '401':
        description: Invalid or missing signature
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

  SubscriptionTier:
    type: string
    enum: [STANDARD, CREATOR, PRO, FOUNDERS_EDITION]
    description: Subscription tier (uppercase to match comfy-api)

  SubscriptionDuration:
    type: string
    enum: [MONTHLY, ANNUAL]
    description: Billing period (uppercase to match comfy-api)

  BillingStatus:
    type: string
    enum:
      [awaiting_payment_method, pending_payment, paid, payment_failed, inactive]
    description: Payment lifecycle status

  SubscriptionStatus:
    type: string
    enum: [active, scheduled, ended, canceled]
    description: Subscription activity status

  BillingStatusResponse:
    type: object
    required:
      - is_active
      - has_funds
    properties:
      is_active:
        type: boolean
        description: Whether the workspace has an active subscription
      subscription_status:
        type: string
        enum: [active, ended, canceled]
        description: Subscription activity status (scheduled subscriptions are not returned)
      subscription_tier:
        $ref: '#/components/schemas/SubscriptionTier'
      subscription_duration:
        $ref: '#/components/schemas/SubscriptionDuration'
      plan_slug:
        type: string
        description: Plan identifier (e.g., standard-monthly, team-pro-annual)
      billing_status:
        $ref: '#/components/schemas/BillingStatus'
      has_funds:
        type: boolean
        description: Whether the workspace has available credits
      cancel_at:
        type: string
        format: date-time
        description: When the subscription will become inactive (if canceled)

  BillingBalanceResponse:
    type: object
    required:
      - amount_micros
      - currency
    properties:
      amount_micros:
        type: number
        format: double
        description: The total remaining balance in microamount (1/1,000,000 of the currency unit)
      prepaid_balance_micros:
        type: number
        format: double
        description: The remaining balance from prepaid commits in microamount
      cloud_credit_balance_micros:
        type: number
        format: double
        description: The remaining balance from cloud credits in microamount
      pending_charges_micros:
        type: number
        format: double
        description: The total amount of pending/unbilled charges from draft invoices in microamount
      effective_balance_micros:
        type: number
        format: double
        description: The effective balance (total balance minus pending charges). Can be negative if pending charges exceed the balance.
      currency:
        type: string
        example: 'usd'
        description: Currency code

  BillingEvent:
    type: object
    required:
      - event_type
      - event_id
      - createdAt
    properties:
      event_type:
        type: string
        description: Type of billing event (e.g., subscription.created, payment.succeeded)
      event_id:
        type: string
        description: Unique event identifier
      params:
        type: object
        additionalProperties: true
        description: Event-specific parameters
      createdAt:
        type: string
        format: date-time
        description: When the event occurred

  BillingEventsResponse:
    type: object
    required:
      - total
      - events
      - page
      - limit
      - totalPages
    properties:
      total:
        type: integer
        description: Total number of events
      events:
        type: array
        items:
          $ref: '#/components/schemas/BillingEvent'
      page:
        type: integer
        description: Current page number (1-indexed)
      limit:
        type: integer
        description: Items per page
      totalPages:
        type: integer
        description: Total number of pages

  PlanAvailability:
    type: object
    required:
      - available
    properties:
      available:
        type: boolean
        description: Whether the workspace can subscribe to this plan
      reason:
        $ref: '#/components/schemas/PlanAvailabilityReason'

  PlanAvailabilityReason:
    type: string
    enum:
      - same_plan
      - incompatible_transition
      - requires_team
      - requires_personal
    description: Reason why a plan is unavailable

  Plan:
    type: object
    required:
      - slug
      - tier
      - duration
      - price_cents
      - credits_cents
      - max_seats
      - availability
      - seat_summary
    properties:
      slug:
        type: string
        description: Plan identifier (e.g., "pro-monthly", "team-standard-annual")
        example: 'pro-monthly'
      tier:
        $ref: '#/components/schemas/SubscriptionTier'
      duration:
        $ref: '#/components/schemas/SubscriptionDuration'
      price_cents:
        type: integer
        format: int64
        description: Per-member price in cents (base + one seat)
        example: 10000
      credits_cents:
        type: integer
        format: int64
        description: Per-member credits in cents (base + one seat)
        example: 10000
      max_seats:
        type: integer
        format: int64
        description: Maximum number of seats allowed for this plan
        example: 20
      availability:
        $ref: '#/components/schemas/PlanAvailability'
      seat_summary:
        $ref: '#/components/schemas/PlanSeatSummary'

  PlanSeatSummary:
    type: object
    description: Summary of seat costs based on current workspace members
    required:
      - seat_count
      - total_cost_cents
      - total_credits_cents
    properties:
      seat_count:
        type: integer
        description: Total number of seats (owner + members) that would be charged
        example: 5
      total_cost_cents:
        type: integer
        format: int64
        description: Total cost for all seats in cents
        example: 50000
      total_credits_cents:
        type: integer
        format: int64
        description: Total credits granted for all seats in cents
        example: 50000

  BillingPlansResponse:
    type: object
    required:
      - plans
    properties:
      current_plan_slug:
        type: string
        description: Current plan slug if subscribed
      plans:
        type: array
        items:
          $ref: '#/components/schemas/Plan'

  PreviewSubscribeRequest:
    type: object
    required:
      - plan_slug
    properties:
      plan_slug:
        type: string
        description: Target plan slug to preview subscribing to
        example: 'team-pro-monthly'

  PreviewSubscribeResponse:
    type: object
    required:
      - allowed
      - transition_type
      - effective_at
      - is_immediate
      - cost_today_cents
      - cost_next_period_cents
      - credits_today_cents
      - credits_next_period_cents
      - new_plan
    properties:
      allowed:
        type: boolean
        description: Whether this subscription change is allowed
      reason:
        type: string
        description: Reason why the change is not allowed (only present if allowed=false)
      transition_type:
        type: string
        enum: [new_subscription, upgrade, downgrade, duration_change]
        description: Type of subscription transition
      effective_at:
        type: string
        format: date-time
        description: When the change takes effect
      is_immediate:
        type: boolean
        description: Whether the change takes effect immediately (true) or at period end (false)
      cost_today_cents:
        type: integer
        format: int64
        description: Amount to charge today in cents (0 for downgrades)
        example: 5000
      cost_next_period_cents:
        type: integer
        format: int64
        description: Amount that will be charged at next billing period in cents
        example: 10000
      credits_today_cents:
        type: integer
        format: int64
        description: Credits granted today in cents (prorated for mid-period upgrades)
        example: 5000
      credits_next_period_cents:
        type: integer
        format: int64
        description: Credits that will be granted at next billing period in cents
        example: 10000
      current_plan:
        $ref: '#/components/schemas/PreviewPlanInfo'
      new_plan:
        $ref: '#/components/schemas/PreviewPlanInfo'

  PreviewPlanInfo:
    type: object
    description: Plan information for preview display
    required:
      - slug
      - tier
      - duration
      - price_cents
      - credits_cents
      - seat_summary
    properties:
      slug:
        type: string
        description: Plan slug
        example: 'team-pro-monthly'
      tier:
        $ref: '#/components/schemas/SubscriptionTier'
      duration:
        $ref: '#/components/schemas/SubscriptionDuration'
      price_cents:
        type: integer
        format: int64
        description: Per-seat price in cents
        example: 10000
      credits_cents:
        type: integer
        format: int64
        description: Per-seat credits in cents
        example: 10000
      seat_summary:
        $ref: '#/components/schemas/PlanSeatSummary'
      period_start:
        type: string
        format: date-time
        description: Current billing period start (only for current_plan)
      period_end:
        type: string
        format: date-time
        description: Current billing period end (only for current_plan)

  SubscribeRequest:
    type: object
    required:
      - plan_slug
    properties:
      plan_slug:
        type: string
        description: Target plan slug to subscribe to
        example: 'team-pro-monthly'
      return_url:
        type: string
        description: |
          URL to redirect after payment method is added successfully.
          Required if workspace has no payment method on file.
        example: 'https://cloud.comfy.org/billing/success'
      cancel_url:
        type: string
        description: |
          URL to redirect if user cancels the payment method flow.
          If not provided, return_url is used for both success and cancel.
        example: 'https://cloud.comfy.org/billing'

  SubscribeResponse:
    type: object
    required:
      - status
    properties:
      status:
        type: string
        enum: [subscribed, needs_payment_method]
        description: |
          Status of the subscription operation:
          - subscribed: Subscription is active immediately
          - needs_payment_method: User must add payment method via payment_method_url
      effective_at:
        type: string
        format: date-time
        description: When the subscription became/becomes active (present when status=subscribed)
      payment_method_url:
        type: string
        description: URL to redirect user to add payment method (present when status=needs_payment_method)

  CancelSubscriptionResponse:
    type: object
    required:
      - cancel_at
    properties:
      cancel_at:
        type: string
        format: date-time
        description: The date when the subscription will end (end of current billing period)

  ResubscribeResponse:
    type: object
    required:
      - status
    properties:
      status:
        type: string
        enum: [active]
        description: The subscription status after resubscribing
      message:
        type: string
        description: Human-readable confirmation message

  PaymentPortalRequest:
    type: object
    properties:
      return_url:
        type: string
        description: URL to redirect after the user exits the portal

  PaymentPortalResponse:
    type: object
    required:
      - url
    properties:
      url:
        type: string
        description: Stripe Billing Portal URL
