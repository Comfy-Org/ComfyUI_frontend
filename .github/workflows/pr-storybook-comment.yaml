name: PR Storybook Comment

on:
  workflow_run:
    workflows: ["Chromatic"]
    types: [requested, completed]

jobs:
  comment-storybook:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request'
    permissions:
      pull-requests: write
      actions: read
    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
            });
            
            if (pullRequests.length === 0) {
              console.log('No open PR found for this branch');
              return null;
            }
            
            return pullRequests[0].number;

      - name: Get workflow run details
        if: steps.pr.outputs.result != 'null' && github.event.action == 'completed'
        id: workflow-run
        uses: actions/github-script@v7
        with:
          script: |
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });
            
            return {
              conclusion: run.data.conclusion,
              html_url: run.data.html_url
            };

      - name: Get completion time
        id: completion-time
        run: echo "time=$(date -u '+%m/%d/%Y, %I:%M:%S %p')" >> $GITHUB_OUTPUT

      - name: Comment PR - Storybook Started
        if: steps.pr.outputs.result != 'null' && github.event.action == 'requested'
        continue-on-error: true
        uses: edumserrano/find-create-or-update-comment@v3
        with:
          issue-number: ${{ steps.pr.outputs.result }}
          body-includes: '<!-- STORYBOOK_BUILD_STATUS -->'
          comment-author: 'github-actions[bot]'
          edit-mode: replace
          body: |
            <!-- STORYBOOK_BUILD_STATUS -->
            ## ğŸ¨ Storybook Build Status

            â³ **Build is starting...** 

            â° Started at: ${{ steps.completion-time.outputs.time }} UTC

            ### ğŸš€ Building Storybook
            - ğŸ“¦ Installing dependencies...
            - ğŸ”§ Building Storybook components...
            - ğŸ¨ Running Chromatic visual tests...

            ---
            â±ï¸ Please wait while the Storybook build is in progress...

      - name: Comment PR - Storybook Complete
        if: steps.pr.outputs.result != 'null' && github.event.action == 'completed'
        continue-on-error: true
        uses: edumserrano/find-create-or-update-comment@v3
        with:
          issue-number: ${{ steps.pr.outputs.result }}
          body-includes: '<!-- STORYBOOK_BUILD_STATUS -->'
          comment-author: 'github-actions[bot]'
          edit-mode: replace
          body: |
            <!-- STORYBOOK_BUILD_STATUS -->
            ## ğŸ¨ Storybook Build Status

            ${{ fromJSON(steps.workflow-run.outputs.result).conclusion == 'success' && 'âœ…' || 'âŒ' }} **${{ fromJSON(steps.workflow-run.outputs.result).conclusion == 'success' && 'Build completed successfully!' || 'Build failed!' }}**

            â° Completed at: ${{ steps.completion-time.outputs.time }} UTC

            ### ğŸ”— Links
            - [ğŸ“Š View Workflow Run](${{ fromJSON(steps.workflow-run.outputs.result).html_url }})

            ---
            ${{ fromJSON(steps.workflow-run.outputs.result).conclusion == 'success' && 'ğŸ‰ Your Storybook is ready for review!' || 'âš ï¸ Please check the workflow logs for error details.' }}