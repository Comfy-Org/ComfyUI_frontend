name: PR Playwright Deploy and Comment (Forked PRs)

on:
  workflow_run:
    workflows: ["Tests CI"]
    types: [requested, completed]

env:
  DATE_FORMAT: '+%m/%d/%Y, %I:%M:%S %p'

jobs:
  # Check if this is a forked PR and set output
  check-fork-status:
    runs-on: ubuntu-latest
    if: github.repository == 'Comfy-Org/ComfyUI_frontend' && github.event.workflow_run.event == 'pull_request'
    outputs:
      is_fork: ${{ steps.check.outputs.is_fork }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Check if PR is from fork
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            // Check if this is from a forked repository
            const isForked = context.payload.workflow_run.head_repository.full_name !== context.payload.workflow_run.repository.full_name;
            
            if (!isForked) {
              console.log('PR is not from a fork, skipping this workflow');
              return { is_fork: false, pr_number: null };
            }
            
            console.log(`PR is from forked repository: ${context.payload.workflow_run.head_repository.full_name}`);
            
            // For forked PRs, find the PR number
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
            });
            
            // Find PR by matching head SHA
            const pr = pullRequests.find(pr => pr.head.sha === context.payload.workflow_run.head_sha);
            
            if (!pr) {
              console.log('No open PR found for this forked branch');
              return { is_fork: true, pr_number: null };
            }
            
            console.log(`âœ… Found PR #${pr.number} from fork`);
            return { is_fork: true, pr_number: pr.number };

  comment-tests-starting:
    needs: check-fork-status
    runs-on: ubuntu-latest
    if: needs.check-fork-status.outputs.is_fork == 'true' && needs.check-fork-status.outputs.pr_number != 'null' && github.event.action == 'requested'
    permissions:
      pull-requests: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get start time
        id: start-time
        run: echo "time=$(date -u '${{ env.DATE_FORMAT }}')" >> $GITHUB_OUTPUT

      - name: Post starting comment
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          chmod +x scripts/cicd/pr-playwright-deploy-and-comment.sh
          ./scripts/cicd/pr-playwright-deploy-and-comment.sh \
            "${{ needs.check-fork-status.outputs.pr_number }}" \
            "${{ github.event.workflow_run.head_branch }}" \
            "starting" \
            "${{ steps.start-time.outputs.time }}"

  deploy-and-comment:
    needs: check-fork-status
    runs-on: ubuntu-latest
    if: needs.check-fork-status.outputs.is_fork == 'true' && needs.check-fork-status.outputs.pr_number != 'null' && github.event.action == 'completed'
    permissions:
      actions: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all playwright reports
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          pattern: playwright-report-*
          path: reports
          
      - name: Rename merged chromium report if exists
        run: |
          if [ -d "reports/playwright-report-chromium-merged" ]; then
            mv reports/playwright-report-chromium-merged reports/playwright-report-chromium
          fi

      - name: Deploy reports and comment on PR
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          chmod +x scripts/cicd/pr-playwright-deploy-and-comment.sh
          ./scripts/cicd/pr-playwright-deploy-and-comment.sh \
            "${{ needs.check-fork-status.outputs.pr_number }}" \
            "${{ github.event.workflow_run.head_branch }}" \
            "completed"
