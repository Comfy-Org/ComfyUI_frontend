/api/billing/status:
  get:
    tags:
      - billing
    summary: Get billing status
    description: |
      Returns the current billing status for the workspace.
      Requires workspace-scoped authentication.
    operationId: getBillingStatus
    security:
      - BearerAuth: []
    responses:
      '200':
        description: Billing status
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BillingStatusResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '404':
        description: Workspace not found
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/balance:
  get:
    tags:
      - billing
    summary: Get credit balance
    description: |
      Returns the current credit balance for the workspace from Metronome.
      This is a GET endpoint that may occasionally write (to update has_funds status).
    operationId: getBillingBalance
    security:
      - BearerAuth: []
    responses:
      '200':
        description: Credit balance
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BillingBalanceResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/events:
  get:
    tags:
      - billing
    summary: Get billing events
    description: |
      Returns paginated billing events for the workspace.
      Events include subscription changes, payments, and credit adjustments.
    operationId: getBillingEvents
    security:
      - BearerAuth: []
    parameters:
      - name: page
        in: query
        schema:
          type: integer
          minimum: 1
          default: 1
        description: Page number (1-indexed)
      - name: limit
        in: query
        schema:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
        description: Number of events per page
    responses:
      '200':
        description: Paginated billing events
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BillingEventsResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/plans:
  get:
    tags:
      - billing
    summary: Get available subscription plans
    description: |
      Returns all subscription plans with pricing and availability for the workspace.
      Availability indicates whether the workspace can subscribe to each plan.
    operationId: getBillingPlans
    security:
      - BearerAuth: []
    responses:
      '200':
        description: Available plans with pricing
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BillingPlansResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/preview-subscribe:
  post:
    tags:
      - billing
    summary: Preview what will happen when subscribing to a plan
    description: |
      Returns a preview of the subscription transition including:
      - Cost to charge today (for upgrades/new subscriptions)
      - Cost at next billing period
      - Credits granted today (prorated for upgrades)
      - Credits granted at next billing period

      This endpoint does not execute any billing operations.
      Use it to show the user what will happen before they confirm.
    operationId: previewSubscribe
    security:
      - BearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/PreviewSubscribeRequest'
    responses:
      '200':
        description: Subscription preview
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PreviewSubscribeResponse'
      '400':
        description: Invalid request (e.g., invalid plan slug, seats below minimum)
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/subscribe:
  post:
    tags:
      - billing
    summary: Subscribe to a billing plan
    description: |
      Subscribes the workspace to the specified plan. Flow depends on payment method:

      **If workspace has payment method:**
      - Creates subscription immediately
      - Returns status="subscribed" with effective_at timestamp

      **If workspace needs payment method:**
      - Creates scheduled subscription (status=scheduled)
      - Returns status="needs_payment_method" with payment_method_url
      - After payment method is added via checkout, subscription is finalized

      For existing subscriptions, this performs a plan change (upgrade/downgrade).
    operationId: subscribe
    security:
      - BearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SubscribeRequest'
    responses:
      '200':
        description: Subscription created or payment method needed
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubscribeResponse'
      '400':
        description: Invalid request (e.g., invalid plan slug, incompatible plan)
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/subscription/cancel:
  post:
    tags:
      - billing
    summary: Cancel the current subscription
    description: |
      Cancels the workspace's active subscription at the end of the current billing period.
      The subscription remains active until the period ends, then transitions to ended.

      Returns the date when the subscription will end.
    operationId: cancelSubscription
    security:
      - BearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/CancelSubscriptionRequest'
    responses:
      '200':
        description: Subscription cancellation scheduled
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelSubscriptionResponse'
      '400':
        description: Invalid request (e.g., no active subscription)
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/subscription/resubscribe:
  post:
    tags:
      - billing
    summary: Resubscribe (undo cancel) before period ends
    description: |
      Reverses a scheduled subscription cancellation before the period ends.
      If the subscription has a cancel_at date set (scheduled to cancel at period end),
      this clears the cancellation and resumes the subscription.

      This operation:
      1. Clears the cancel_at date on the subscription
      2. Sets subscription status back to active
      3. Clears the ending_before on the Metronome recurring commit

      Can only be called while the subscription is still in the cancellation grace period
      (before the period ends). After period end, you must subscribe again.
    operationId: resubscribe
    security:
      - BearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ResubscribeRequest'
    responses:
      '200':
        description: Subscription resumed successfully
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResubscribeResponse'
      '400':
        description: Invalid request (e.g., no active subscription, not in cancellation grace period)
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/payment-portal:
  post:
    tags:
      - billing
    summary: Get payment portal URL
    description: |
      Returns a Stripe Billing Portal URL for managing payment methods.
      The user can add, update, or remove payment methods in the portal.
    operationId: getPaymentPortal
    security:
      - BearerAuth: []
    requestBody:
      required: false
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/PaymentPortalRequest'
    responses:
      '200':
        description: Success
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentPortalResponse'
      '400':
        description: Bad request (e.g., missing return_url)
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/topup:
  post:
    tags:
      - billing
    summary: Create a credit top-up
    description: |
      Initiates a credit top-up for the workspace. Creates a payment-gated prepaid commit
      in Metronome that triggers an immediate Stripe charge. Credits are held until
      payment completes.

      Requires the workspace to have a valid payment method on file. If no payment method
      exists, returns an error directing the user to add one via the payment portal.

      The response includes a topup_id that can be used to poll for status via
      GET /api/billing/topup/{id}.
    operationId: createTopup
    security:
      - BearerAuth: []
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/CreateTopupRequest'
    responses:
      '200':
        description: Top-up initiated successfully
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTopupResponse'
      '400':
        description: Bad request (invalid amount, no payment method)
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/topup/{id}:
  get:
    tags:
      - billing
    summary: Get top-up status
    description: |
      Returns the current status of a credit top-up request.

      Status values:
      - pending: Payment is being processed
      - completed: Payment succeeded, credits granted
      - failed: Payment failed, see error_message for details

      Poll this endpoint after creating a top-up to track payment completion.
    operationId: getTopupStatus
    security:
      - BearerAuth: []
    parameters:
      - name: id
        in: path
        required: true
        description: The top-up ID returned from POST /api/billing/topup
        schema:
          type: string
    responses:
      '200':
        description: Top-up status
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TopupStatusResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '404':
        description: Top-up not found
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'

/api/billing/ops/{id}:
  get:
    tags:
      - billing
    summary: Get billing operation status
    description: |
      Returns the current status of a billing operation.

      All billing mutations (subscribe, cancel, topup, plan change) return a billing_op_id.
      Use this endpoint to poll for completion status.

      Status values:
      - pending: Operation is in progress
      - succeeded: Operation completed successfully
      - failed: Operation failed, see error_message for details
    operationId: getBillingOpStatus
    security:
      - BearerAuth: []
    parameters:
      - name: id
        in: path
        required: true
        description: The billing operation ID
        schema:
          type: string
    responses:
      '200':
        description: Billing operation status
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BillingOpStatusResponse'
      '401':
        description: Unauthorized
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '404':
        description: Billing operation not found
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
      '500':
        description: Internal server error
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorResponse'
