openapi: 3.0.3
info:
  title: ComfyUI API
  description: |
    API for ComfyUI - A powerful and modular UI for Stable Diffusion.

    This API allows you to interact with ComfyUI programmatically, including:
    - Retrieving prompt information
    - Retrieving node information
  version: 1.0.0
  license:
    name: GNU General Public License v3.0
    url: https://github.com/Comfy-Org/ComfyUI/blob/master/LICENSE

servers:
  - url: /
    description: Default ComfyUI server

# Global security - most endpoints require API key or Bearer token authentication
# Cookie auth is only allowed on specific view endpoints (/api/view, /api/viewvideo, /api/vhs/*)
# Individual endpoints can override with empty security: [] for public access
security:
  - ApiKeyAuth: []
  - BearerAuth: []

tags:
  - name: workflow
    description: Workflow execution and management
  - name: node
    description: Node information
  - name: file
    description: File operations
  - name: secrets
    description: User secret management (API keys, tokens)
  - name: settings
    description: User settings management
  - name: feedback
    description: User feedback management
  - name: system
    description: System operations and monitoring
  - name: admin
    description: Administrative operations
  - name: auth
    description: Authentication and session management
  - name: user
    description: User information and management
  - name: task
    description: Background task management
  - name: workspaces
    description: Workspace management
  - name: billing
    description: Workspace billing and subscription management

paths:
  /api/prompt:
    get:
      tags:
        - workflow
      summary: Get information about current prompt execution
      description: Returns information about the current prompt in the execution queue
      operationId: getPromptInfo
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PromptInfo'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags:
        - workflow
      summary: Submit a workflow for execution
      description: |
        Submit a workflow to be executed by the backend.
        The workflow is a JSON object describing the nodes and their connections.
      operationId: executePrompt
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PromptRequest'
      responses:
        '200':
          description: Success - Prompt accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PromptResponse'
        '400':
          description: Invalid prompt
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PromptErrorResponse'
        '402':
          description: Payment required - Insufficient credits
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PromptErrorResponse'
        '429':
          description: Payment required - User has not paid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PromptErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PromptErrorResponse'
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PromptErrorResponse'
  /api/object_info:
    get:
      tags:
        - node
      summary: Get all node information
      description: Returns information about all available nodes
      operationId: getNodeInfo
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  $ref: '#/components/schemas/NodeInfo'

  /api/features:
    get:
      tags:
        - node
      summary: Get server feature flags
      description: Returns the server's feature capabilities
      operationId: getFeatures
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
        - CookieAuth: []
        - {}  # Also allows unauthenticated access (optional auth)
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  supports_preview_metadata:
                    type: boolean
                    description: Whether the server supports preview metadata
                  max_upload_size:
                    type: integer
                    description: Maximum upload size in bytes
                additionalProperties: true

  /api/workflow_templates:
    get:
      tags:
        - workflow
      summary: Get available workflow templates
      description: Returns available workflow templates
      operationId: getWorkflowTemplates
      security: []  # Public endpoint
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                description: Empty object for workflow templates

  /api/global_subgraphs:
    get:
      tags:
        - workflow
      summary: Get available subgraph blueprints
      description: |
        Returns a list of globally available subgraph blueprints.
        These are pre-built workflow components that can be used as nodes.
        The data field contains a promise that resolves to the full subgraph JSON.
      operationId: getGlobalSubgraphs
      security: []  # Public endpoint
      responses:
        '200':
          description: Success - Map of subgraph IDs to their metadata
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  $ref: '#/components/schemas/GlobalSubgraphInfo'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/global_subgraphs/{id}:
    get:
      tags:
        - workflow
      summary: Get a specific subgraph blueprint
      description: Returns the full data for a specific subgraph blueprint by ID
      operationId: getGlobalSubgraph
      security: []  # Public endpoint
      parameters:
        - name: id
          in: path
          required: true
          description: The unique identifier of the subgraph blueprint
          schema:
            type: string
      responses:
        '200':
          description: Success - Full subgraph data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GlobalSubgraphData'
        '404':
          description: Subgraph not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/experiment/models:
    get:
      tags:
        - file
      summary: Get available model folders
      description: |
        Returns a list of model folders available in the system.
        This is an experimental endpoint that replaces the legacy /models endpoint.
      operationId: getModelFolders
      security: []  # Public endpoint
      responses:
        '200':
          description: Success - List of model folders
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ModelFolder'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/experiment/models/{folder}:
    get:
      tags:
        - file
      summary: Get models in a specific folder
      description: |
        Returns a list of models available in the specified folder.
        This is an experimental endpoint that provides enhanced model information.
      operationId: getModelsInFolder
      security: []  # Public endpoint
      parameters:
        - name: folder
          in: path
          required: true
          description: The folder name to list models from
          schema:
            type: string
            example: "checkpoints"
      responses:
        '200':
          description: Success - List of models in the folder
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ModelFile'
        '404':
          description: Folder not found or no models in folder
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/experiment/models/preview/{folder}/{path_index}/{filename}:
    get:
      tags:
        - file
      summary: Get model preview image
      description: |
        Returns a preview image for the specified model.
        The image is returned in WebP format for optimal performance.
      operationId: getModelPreview
      security: []  # Public endpoint
      parameters:
        - name: folder
          in: path
          required: true
          description: The folder name containing the model
          schema:
            type: string
            example: "checkpoints"
        - name: path_index
          in: path
          required: true
          description: The path index (usually 0 for cloud service)
          schema:
            type: integer
            example: 0
        - name: filename
          in: path
          required: true
          description: The model filename (with or without .webp extension)
          schema:
            type: string
            example: "model.safetensors"
      responses:
        '200':
          description: Success - Model preview image
          content:
            image/webp:
              schema:
                type: string
                format: binary
        '404':
          description: Model not found or preview not available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/history:
    post:
      tags:
        - workflow
      summary: Manage execution history
      description: |
        Clear all history for the authenticated user or delete specific job IDs.
        Supports clearing all history or deleting specific job IDs.
      operationId: manageHistory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HistoryManageRequest'
      responses:
        '200':
          description: Success - History management operation completed
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized - Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/history_v2:
    get:
      tags:
        - workflow
      summary: Get execution history (v2)
      description: |
        Retrieve execution history for the authenticated user with pagination support.
        Returns a lightweight history format with filtered prompt data (workflow removed from extra_pnginfo).
      operationId: getHistory
      parameters:
        - name: max_items
          in: query
          required: false
          description: Maximum number of items to return
          schema:
            type: integer
        - name: offset
          in: query
          required: false
          description: Starting position (default 0)
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Success - Execution history retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HistoryResponse'
        '401':
          description: Unauthorized - Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/history_v2/{prompt_id}:
    get:
      tags:
        - workflow
      summary: Get history for specific prompt
      description: |
        Retrieve detailed execution history for a specific prompt ID.
        Returns full history data including complete prompt information.
      operationId: getHistoryForPrompt
      parameters:
        - name: prompt_id
          in: path
          required: true
          description: The prompt ID to retrieve history for
          schema:
            type: string
      responses:
        '200':
          description: Success - History for prompt retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HistoryDetailResponse'
        '401':
          description: Unauthorized - Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Prompt not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/jobs:
    get:
      tags:
        - workflow
      summary: List jobs with pagination and filtering
      description: |
        Retrieve a paginated list of jobs for the authenticated user.
        Returns lightweight job data optimized for list views.
        Workflow and full outputs are excluded to reduce payload size.
      operationId: listJobs
      parameters:
        - name: status
          in: query
          required: false
          description: Filter by one or more statuses (comma-separated). If not provided, returns all jobs.
          schema:
            type: string
          example: pending,in_progress
        - name: workflow_id
          in: query
          required: false
          description: Filter by workflow ID (exact match)
          schema:
            type: string
          example: 550e8400-e29b-41d4-a716-446655440000
        - name: output_type
          in: query
          required: false
          description: Filter by output media type (only applies to completed jobs with outputs)
          schema:
            type: string
            enum: [image, video, audio]
          example: image
        - name: sort_by
          in: query
          required: false
          description: Field to sort by (create_time = when job was submitted, execution_time = how long workflow took to run)
          schema:
            type: string
            enum: [create_time, execution_time]
            default: create_time
          example: execution_time
        - name: sort_order
          in: query
          required: false
          description: Sort direction (asc = ascending, desc = descending)
          schema:
            type: string
            enum: [asc, desc]
            default: desc
        - name: offset
          in: query
          required: false
          description: Pagination offset (0-based)
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: limit
          in: query
          required: false
          description: Maximum items per page (1-1000)
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
      responses:
        '200':
          description: Success - Jobs retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobsListResponse'
        '401':
          description: Unauthorized - Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/jobs/{job_id}:
    get:
      tags:
        - workflow
      summary: Get full job details
      description: |
        Retrieve complete details for a specific job including workflow and outputs.
        Used for detail views, workflow re-execution, and debugging.
      operationId: getJobDetail
      parameters:
        - name: job_id
          in: path
          required: true
          description: Job identifier (UUID)
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Success - Job details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobDetailResponse'
        '401':
          description: Unauthorized - Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - Job does not belong to user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/view:
    get:
      tags:
        - file
      summary: View a file
      description: |
        Retrieve and view a file from the ComfyUI file system.
        This endpoint is typically used to view generated images or other output files.
        Cookie auth is allowed on this endpoint because it's used by img/video tags in browsers.
      operationId: viewFile
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
        - CookieAuth: []
      parameters:
        - name: filename
          in: query
          required: true
          description: Name of the file to view
          schema:
            type: string
            example: "ComfyUI_00004_.png"
        - name: subfolder
          in: query
          required: false
          description: Subfolder path where the file is located
          schema:
            type: string
            example: "tests/foo/bar"
        - name: type
          in: query
          required: false
          description: Type of file (e.g., output, input, temp)
          schema:
            type: string
            example: "output"
        - name: fullpath
          in: query
          required: false
          description: Full path to the file (used for temp files)
          schema:
            type: string
        - name: format
          in: query
          required: false
          description: Format of the file
          schema:
            type: string
        - name: frame_rate
          in: query
          required: false
          description: Frame rate for video files
          schema:
            type: integer
        - name: workflow
          in: query
          required: false
          description: Workflow identifier
          schema:
            type: string
        - name: timestamp
          in: query
          required: false
          description: Timestamp parameter
          schema:
            type: integer
            example: "1234567890"
        - name: channel
          in: query
          required: false
          description: |
            Image channel to extract from PNG images.
            - 'rgb': Return only RGB channels (alpha set to fully opaque)
            - 'a' or 'alpha': Return alpha channel as grayscale image
            - If not specified, return original image unchanged via redirect
          schema:
            type: string
            example: "rgb"
      responses:
        '302':
          description: Redirect to GCS signed URL
          headers:
            Location:
              description: Signed URL to access the file in GCS
              schema:
                type: string
        '200':
          description: Success - File content returned (used when channel parameter is present)
          content:
            image/png:
              schema:
                type: string
                format: binary
              description: Processed PNG image with extracted channel
        '404':
          description: File not found or unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/files/mask-layers:
    get:
      tags:
        - file
      summary: Get related mask layer files
      description: |
        Given a mask file (any of the 4 layers), returns all related mask layer files.
        This is used by the mask editor to load the paint, mask, and painted layers
        when reopening a previously edited mask.
      operationId: getMaskLayers
      parameters:
        - name: filename
          in: query
          required: true
          description: Hash filename of any mask layer file
          schema:
            type: string
            example: "abc123def456.png"
      responses:
        '200':
          description: Success - Related mask layers returned
          content:
            application/json:
              schema:
                type: object
                properties:
                  mask:
                    type: string
                    description: Filename of the mask layer
                    nullable: true
                  paint:
                    type: string
                    description: Filename of the paint strokes layer
                    nullable: true
                  painted:
                    type: string
                    description: Filename of the painted image layer
                    nullable: true
                  painted_masked:
                    type: string
                    description: Filename of the final composite layer
                    nullable: true
        '404':
          description: File not found or not a mask file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /internal/files/{directory_type}:
    get:
      tags:
        - file
      summary: List files in a directory
      description: |
        List all files in the specified directory type.
        For 'output' directory type, files are fetched from the database outputs table.
        For 'input' and 'temp' directory types, files are listed from the file system.
      operationId: getFiles
      x-internal: true  # Excluded from public SDK generation
      parameters:
        - name: directory_type
          in: path
          required: true
          description: Type of directory to list files from
          schema:
            type: string
            enum: ["output", "input", "temp"]
      responses:
        '200':
          description: Success - List of files returned
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
                description: Array of file names sorted by modification time (newest first)
        '400':
          description: Invalid directory type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/assets:
    get:
      tags:
        - file
      summary: List user assets
      description: |
        Retrieves a paginated list of assets belonging to the authenticated user.
        Supports filtering by tags, name, metadata, and sorting options.
      operationId: listAssets
      parameters:
        - name: include_tags
          in: query
          description: Filter assets that have ALL of these tags
          schema:
            type: array
            items:
              type: string
          style: form
          explode: false
        - name: exclude_tags
          in: query
          description: Exclude assets that have ANY of these tags
          schema:
            type: array
            items:
              type: string
          style: form
          explode: false
        - name: name_contains
          in: query
          description: Filter assets where name contains this substring (case-insensitive)
          schema:
            type: string
        - name: metadata_filter
          in: query
          description: JSON object for filtering by metadata fields
          schema:
            type: string
        - name: limit
          in: query
          description: Maximum number of assets to return (1-500)
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 20
        - name: offset
          in: query
          description: Number of assets to skip for pagination
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: sort
          in: query
          description: Field to sort by
          schema:
            type: string
            enum: [name, created_at, updated_at, size, last_access_time]
            default: created_at
        - name: order
          in: query
          description: Sort order
          schema:
            type: string
            enum: [asc, desc]
            default: desc
        - name: include_public
          in: query
          description: Whether to include public/shared assets in results
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: Success - Assets returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListAssetsResponse'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags:
        - file
      summary: Upload a new asset
      description: |
        Uploads a new asset to the system with associated metadata.
        Supports two upload methods:
        1. Direct file upload (multipart/form-data)
        2. URL-based upload (application/json with source: "url")

        If an asset with the same hash already exists, returns the existing asset.
      operationId: uploadAsset
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: The asset file to upload
                tags:
                  type: array
                  items:
                    type: string
                  description: Freeform tags for the asset. Common types include "models", "input", "output", and "temp", but any tag can be used in any order.
                id:
                  type: string
                  format: uuid
                  description: Optional asset ID for idempotent creation. If provided and asset exists, returns existing asset.
                preview_id:
                  type: string
                  format: uuid
                  description: Optional preview asset ID. If not provided, images will use their own ID as preview.
                name:
                  type: string
                  description: Display name for the asset
                mime_type:
                  type: string
                  description: MIME type of the asset (e.g., "image/png", "video/mp4")
                user_metadata:
                  type: string
                  description: Custom JSON metadata as a string
          application/json:
            schema:
              type: object
              required:
                - url
                - name
              properties:
                url:
                  type: string
                  format: uri
                  description: HTTP/HTTPS URL to download the asset from
                name:
                  type: string
                  description: Display name for the asset (used to determine file extension)
                tags:
                  type: array
                  items:
                    type: string
                  description: Freeform tags for the asset. Common types include "models", "input", "output", and "temp", but any tag can be used in any order.
                user_metadata:
                  type: object
                  additionalProperties: true
                  description: Custom metadata to store with the asset
                preview_id:
                  type: string
                  format: uuid
                  description: Optional preview asset ID
      responses:
        '201':
          description: Asset created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetCreated'
        '200':
          description: Asset already exists (returned existing asset)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetCreated'
        '400':
          description: Invalid request (bad file, invalid URL, invalid content type, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Source URL requires authentication or access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Source URL not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '413':
          description: File too large
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '415':
          description: Unsupported media type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Download failed due to network error or timeout
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/assets/from-hash:
    post:
      tags:
        - file
      summary: Create asset reference from existing hash
      description: |
        Creates a new asset reference using an existing asset's hash.
        This avoids re-uploading the file content when the asset already exists in storage.
        The user can provide their own metadata and tags for the reference.
      operationId: createAssetFromHash
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - hash
                - tags
              properties:
                hash:
                  type: string
                  description: Hash of the existing asset. Supports Blake3 (blake3:) or SHA256 (sha256:) formats
                  pattern: '^(blake3|sha256):[a-f0-9]{64}$'
                name:
                  type: string
                  description: Display name for the asset reference (optional)
                tags:
                  type: array
                  items:
                    type: string
                  minItems: 1
                  description: Freeform tags for the asset. Common types include "models", "input", "output", and "temp", but any tag can be used in any order.
                mime_type:
                  type: string
                  description: MIME type of the asset (e.g., "image/png", "video/mp4")
                user_metadata:
                  type: object
                  description: Custom metadata for this asset reference
                  additionalProperties: true
      responses:
        '201':
          description: Asset reference created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetCreated'
        '200':
          description: Asset reference already exists (returned existing)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetCreated'
        '400':
          description: Invalid request (bad hash format, invalid tags, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Source asset with given hash not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/assets/remote-metadata:
    get:
      tags:
        - file
      summary: Get asset metadata from remote URL
      description: |
        Retrieves metadata for an asset from a remote download URL without downloading the entire file.
        Supports various sources including CivitAI and other model repositories.
        Uses HEAD requests or API calls to fetch metadata efficiently.
        This endpoint is for previewing metadata before downloading, not for getting metadata of existing assets.
      operationId: getRemoteAssetMetadata
      parameters:
        - name: url
          in: query
          required: true
          description: Download URL to retrieve metadata from
          schema:
            type: string
            format: uri
            example: 'https://civitai.com/api/download/models/123456'
      responses:
        '200':
          description: Metadata retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetMetadataResponse'
        '400':
          description: Invalid URL or missing required parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Failed to retrieve metadata from source
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/assets/download:
    post:
      tags:
        - file
      summary: Initiate background download for large files
      description: |
        Initiates a background download job for large files from Huggingface or Civitai.

        If the file already exists in storage, the asset record is created immediately and returned (200 OK).
        If the file doesn't exist, a background task is created and the task ID is returned (202 Accepted).
        The frontend can track progress using GET /api/tasks/{task_id}.
      operationId: createAssetDownload
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - source_url
              properties:
                source_url:
                  type: string
                  format: uri
                  description: URL of the file to download (must be from huggingface.co or civitai.com)
                  example: "https://huggingface.co/runwayml/stable-diffusion-v1-5/resolve/main/v1-5-pruned.safetensors"
                tags:
                  type: array
                  items:
                    type: string
                  description: Optional tags for the asset (e.g., ["model", "checkpoint"])
                user_metadata:
                  type: object
                  additionalProperties: true
                  description: Optional user-defined metadata to attach to the asset
                preview_id:
                  type: string
                  format: uuid
                  description: Optional preview asset ID to associate with the downloaded asset
                  example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: File already exists in storage - asset created/returned immediately
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetCreated'
        '202':
          description: Accepted - Download task created and processing in background
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetDownloadResponse'
        '400':
          description: Invalid URL or unsupported source
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation errors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/assets/export:
    post:
      tags:
        - file
      summary: Initiate background ZIP export for multiple assets
      description: |
        Initiates a background task to export a ZIP file from assets resolved by job IDs and/or selected by asset IDs.
        The frontend can track progress using GET /api/tasks/{task_id}.
        At least one of `job_ids` or `asset_ids` must be provided.
      operationId: createAssetExport
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                job_ids:
                  type: array
                  items:
                    type: string
                  description: Job IDs to include *all associated assets* of the jobs in the ZIP bundle.
                  example: ["833a1b5c-beab-436a-ae8e-f07e7cd7b2c4"]
                asset_ids:
                  type: array
                  items:
                    type: string
                  description: Asset IDs to include in the ZIP bundle. Additive to the assets associated with provided job IDs.
                  example: ["833a1b5c-beab-436a-ae8e-f07e7cd7b2c4"]
                naming_strategy:
                  type: string
                  enum: [group_by_job_id, prepend_job_id, preserve, asset_id]
                  default: prepend_job_id
                  description: |
                    Strategy for naming files in the ZIP:
                    - group_by_job_id: Group assets by job ID as a parent directory (e.g., "833a1b5c-beab-436a-ae8e-f07e7cd7b2c4/ComfyUI_00001_.png")
                    - prepend_job_id: Prepend job ID to filenames for uniqueness (e.g., "833a1b5c-beab-436a-ae8e-f07e7cd7b2c4_ComfyUI_00001_.png")
                    - preserve: Use original asset names, skip duplicates (first one wins)
                    - asset_id: Use the asset ID as the filename (e.g., "833a1b5c-beab-436a-ae8e-f07e7cd7b2c4.png")
      responses:
        '202':
          description: Accepted - Export task created and processing in background
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetDownloadResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/assets/exports/{exportName}:
    get:
      tags:
        - file
      summary: Get a URL for downloading an export file
      description: |
        Returns a URL for downloading the export file.
        The export must have been created by the authenticated user.
      operationId: downloadExport
      parameters:
        - name: exportName
          in: path
          required: true
          description: Export filename with extension (e.g., "021e55cd-9785-4ac7-ac39-f4010138e3bc.zip")
          schema:
            type: string
            pattern: '^[a-zA-Z0-9_-]+\.zip$'
      responses:
        '200':
          description: Signed URL for downloading the export
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportDownloadURLResponse'
        '400':
          description: Invalid export name
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Export not found or not owned by user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/assets/{id}:
    get:
      tags:
        - file
      summary: Get asset details
      description: Retrieves detailed information about a specific asset
      operationId: getAssetById
      parameters:
        - name: id
          in: path
          required: true
          description: Asset ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Asset details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Asset'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Asset not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      tags:
        - file
      summary: Update asset metadata
      description: |
        Updates an asset's metadata. At least one field must be provided.
        Only name, mime_type, preview_id, and user_metadata can be updated.
        For tag management, use the dedicated PUT /api/assets/{id}/tags endpoint.
      operationId: updateAsset
      parameters:
        - name: id
          in: path
          required: true
          description: Asset ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  description: New display name for the asset
                mime_type:
                  type: string
                  description: Updated MIME type of the asset
                preview_id:
                  type: string
                  format: uuid
                  description: Updated preview asset ID
                user_metadata:
                  type: object
                  description: Updated custom metadata
                  additionalProperties: true
              minProperties: 1
      responses:
        '200':
          description: Asset updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetUpdated'
        '400':
          description: Invalid request (no fields provided)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Asset not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags:
        - file
      summary: Delete asset
      description: |
        Deletes an asset and its content from storage.
        Both the database record and storage content are deleted.
      operationId: deleteAsset
      parameters:
        - name: id
          in: path
          required: true
          description: Asset ID
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Asset deleted successfully
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Asset not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/assets/{id}/tags:
    post:
      tags:
        - file
      summary: Add tags to asset
      description: Adds one or more tags to an existing asset
      operationId: addAssetTags
      parameters:
        - name: id
          in: path
          required: true
          description: Asset ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - tags
              properties:
                tags:
                  type: array
                  items:
                    type: string
                  minItems: 1
                  description: Tags to add to the asset
      responses:
        '200':
          description: Tags added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TagsModificationResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Asset not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error (e.g., reserved tag)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags:
        - file
      summary: Remove tags from asset
      description: Removes one or more tags from an existing asset
      operationId: removeAssetTags
      parameters:
        - name: id
          in: path
          required: true
          description: Asset ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - tags
              properties:
                tags:
                  type: array
                  items:
                    type: string
                  minItems: 1
                  description: Tags to remove from the asset
      responses:
        '200':
          description: Tags removed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TagsModificationResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Asset not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error (e.g., reserved tag)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      tags:
        - file
      summary: Update asset tags
      description: Adds and removes tags from an asset in a single operation
      operationId: updateAssetTags
      parameters:
        - name: id
          in: path
          required: true
          description: Asset ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: At least one of add or remove must contain items. Empty arrays are allowed when the other array has items.
              minProperties: 1
              properties:
                add:
                  type: array
                  items:
                    type: string
                  description: Tags to add to the asset. Can be empty if remove has items.
                remove:
                  type: array
                  items:
                    type: string
                  description: Tags to remove from the asset. Can be empty if add has items.
      responses:
        '200':
          description: Tags updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TagsModificationResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Asset not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Reserved tag validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/tags:
    get:
      tags:
        - file
      summary: List all tags
      description: |
        Retrieves a list of all tags used across assets.
        Includes usage counts and filtering options.
      operationId: listTags
      parameters:
        - name: prefix
          in: query
          description: Filter tags by prefix
          schema:
            type: string
        - name: limit
          in: query
          description: Maximum number of tags to return (1-1000)
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
        - name: offset
          in: query
          description: Number of tags to skip for pagination
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: order
          in: query
          description: Sort order for tags
          schema:
            type: string
            enum: [count_desc, name_asc]
            default: count_desc
        - name: include_zero
          in: query
          description: Include tags with zero usage count
          schema:
            type: boolean
            default: false
        - name: include_public
          in: query
          description: Whether to include public/shared assets when counting tags
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: Tags retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListTagsResponse'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/assets/tags/refine:
    get:
      tags:
        - file
      summary: Get tag histogram for filtered assets
      description: |
        Returns a histogram of tags appearing on assets matching the given filters.
        Useful for refining asset searches by showing available tags and their counts.
        Only returns tags with non-zero counts (tags that exist on matching assets).
      operationId: getAssetTagHistogram
      parameters:
        - name: include_tags
          in: query
          description: Filter assets that have ALL of these tags
          schema:
            type: array
            items:
              type: string
          style: form
          explode: false
        - name: exclude_tags
          in: query
          description: Exclude assets that have ANY of these tags
          schema:
            type: array
            items:
              type: string
          style: form
          explode: false
        - name: name_contains
          in: query
          description: Filter assets where name contains this substring (case-insensitive)
          schema:
            type: string
        - name: metadata_filter
          in: query
          description: JSON object for filtering by metadata fields
          schema:
            type: string
        - name: limit
          in: query
          description: Maximum number of tags to return (1-1000, default 100)
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
        - name: include_public
          in: query
          description: Whether to include public/shared assets in results
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: Success - Tag histogram returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetTagHistogramResponse'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/assets/hash/{hash}:
    head:
      tags:
        - file
      summary: Check if asset exists by hash
      description: |
        Checks if an asset exists in the system by its blake3 hash.
        Returns 200 if the asset exists, 404 if it doesn't.
      operationId: checkAssetByHash
      parameters:
        - name: hash
          in: path
          required: true
          description: Blake3 hash of the asset in format 'blake3:hex_digest'
          schema:
            type: string
            pattern: '^blake3:[a-f0-9]{64}$'
            example: 'blake3:a1b2c3d4e5f6789012345678901234567890123456789012345678901234'
      responses:
        '200':
          description: Asset exists
        '400':
          description: Invalid hash format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Asset not found
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/internal/cloud_analytics:
    post:
      tags:
        - system
      summary: Record frontend analytics event
      description: Accepts analytics events from the frontend and records them to the analytics system
      operationId: postCloudAnalytics
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                event_name:
                  type: string
                  description: The name/type of the event
                event_data:
                  description: The event data (can be any JSON value - string, number, object, array, boolean, or null)
              required:
                - event_name
                - event_data
      responses:
        '200':
          description: Analytics event recorded successfully
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/queue:
    get:
      tags:
        - queue
      summary: Get queue information
      description: Returns information about running and pending items in the queue
      operationId: getQueueInfo
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueInfo'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags:
        - queue
      summary: Manage queue operations
      description: |
        Cancel specific PENDING jobs by ID or clear all pending jobs in the queue.
        Note: This endpoint only affects pending jobs. To cancel running jobs, use /api/interrupt.
      operationId: manageQueue
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueueManageRequest'
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueManageResponse'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/interrupt:
    post:
      tags:
        - queue
      summary: Interrupt currently running jobs
      description: |
        Cancel all currently RUNNING jobs for the authenticated user.
        This will interrupt any job that is currently in 'in_progress' status.
        Note: This endpoint only affects running jobs. To cancel pending jobs, use /api/queue.
      operationId: interruptJob
      responses:
        '200':
          description: Success - Job interrupted or no running job found
        '401':
          description: Unauthorized - Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/secrets:
    get:
      tags:
        - secrets
      summary: List user secrets
      description: Returns all secrets for the authenticated user in the current workspace. Does not return plaintext secret values.
      operationId: listSecrets
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecretListResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Service unavailable - feature is disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags:
        - secrets
      summary: Create a new secret
      description: Store an encrypted secret (e.g., HuggingFace or Civitai API key) for the authenticated user in the current workspace.
      operationId: createSecret
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSecretRequest'
      responses:
        '201':
          description: Secret created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecretResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Conflict - secret with this name or provider already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Service unavailable - secrets feature disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/secrets/{id}:
    get:
      tags:
        - secrets
      summary: Get secret metadata
      description: Returns metadata for a specific secret. Does not return the plaintext secret value.
      operationId: getSecret
      parameters:
        - name: id
          in: path
          required: true
          description: The UUID of the secret
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecretResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - user does not own this secret
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Secret not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Service unavailable - secrets feature disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    patch:
      tags:
        - secrets
      summary: Update secret
      description: Update an existing secret's name and/or value. Both fields are optional; only provided fields will be updated.
      operationId: updateSecret
      parameters:
        - name: id
          in: path
          required: true
          description: The UUID of the secret
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateSecretRequest'
      responses:
        '200':
          description: Secret updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecretResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - user does not own this secret
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Secret not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Conflict - a secret with this name already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Service unavailable - secrets feature disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags:
        - secrets
      summary: Delete secret
      description: Remove a secret and its encrypted value from storage.
      operationId: deleteSecret
      parameters:
        - name: id
          in: path
          required: true
          description: The UUID of the secret
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Secret deleted successfully
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - user does not own this secret
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Secret not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Service unavailable - secrets feature disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/settings:
    get:
      tags:
        - settings
      summary: Get all user settings
      description: Returns all settings for the authenticated user
      operationId: getAllSettings
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
                description: User settings as key-value pairs
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags:
        - settings
      summary: Update multiple settings
      description: Update multiple settings (merge with existing)
      operationId: updateMultipleSettings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
              description: Settings to update as key-value pairs
          text/plain:
            schema:
              type: string
              description: JSON string of settings to update
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
                description: Updated user settings
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/settings/{key}:
    get:
      tags:
        - settings
      summary: Get a specific setting by key
      description: Returns a specific setting value by its key
      operationId: getSettingByKey
      parameters:
        - name: key
          in: path
          required: true
          description: Setting key to retrieve
          schema:
            type: string
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                description: Setting value response
                properties:
                  value:
                    description: The setting value
        '404':
          description: Setting not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags:
        - settings
      summary: Update a specific setting by key
      description: Update a specific setting by its key
      operationId: updateSettingByKey
      parameters:
        - name: key
          in: path
          required: true
          description: Setting key to update
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              description: New value for the setting
          text/plain:
            schema:
              type: string
              description: JSON string of the new setting value
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                description: Updated setting value response
                properties:
                  value:
                    description: The updated setting value
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/feedback:
    post:
      tags:
        - feedback
      summary: Submit user feedback
      description: Submit feedback about the ComfyUI service
      operationId: submitFeedback
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeedbackRequest'
      responses:
        '201':
          description: Feedback submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeedbackResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/userdata:
    get:
      operationId: getUserdata
      summary: List user data files
      description: Returns a list of user data files in the specified directory, optionally recursively and with full metadata.
      parameters:
        - name: dir
          in: query
          required: false
          description: The directory to list files from.
          schema:
            type: string
        - name: recurse
          in: query
          required: false
          description: Whether to list files recursively.
          schema:
            type: boolean
            default: false
        - name: split
          in: query
          required: false
          description: Whether to split file information by type.
          schema:
            type: boolean
            default: false
        - name: full_info
          in: query
          required: false
          description: Whether to return full file metadata.
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: A list of user data files.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetUserDataResponseFull'
        '400':
          description: Bad request (e.g., invalid filename).
          content:
            text/plain:
              schema:
                type: string
        '401':
          description: Unauthorized.
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: File not found or invalid path.
          content:
            text/plain:
              schema:
                type: string
        '500':
          description: General error
          content:
            text/plain:
              schema:
                type: string

  /api/userdata/{file}:
    get:
      operationId: getUserdataFile
      summary: Get user data file
      description: Returns the requested user data file if it exists.
      parameters:
        - name: file
          in: path
          required: true
          description: The filename of the user data to retrieve.
          schema:
            type: string
      responses:
        '200':
          description: Successfully retrieved the file.
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '400':
          description: Bad request (e.g., invalid filename).
          content:
            text/plain:
              schema:
                type: string
        '401':
          description: Unauthorized.
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: File not found or invalid path.
          content:
            text/plain:
              schema:
                type: string
        '500':
          description: General error
          content:
            text/plain:
              schema:
                type: string
    post:
      operationId: postUserdataFile
      summary: Upload or update a user data file
      description: |
        Upload a file to a user's data directory. Optional query parameters allow
        control over overwrite behavior and response detail.
      parameters:
        - name: file
          in: path
          required: true
          description: The target file path (URL encoded if necessary).
          schema:
            type: string
        - name: overwrite
          in: query
          required: false
          description: If "false", prevents overwriting existing files. Defaults to "true".
          schema:
            type: string
            enum: ["true", "false"]
            default: "true"
        - name: full_info
          in: query
          required: false
          description: If "true", returns detailed file info; if "false", returns only the relative path.
          schema:
            type: string
            enum: ["true", "false"]
            default: "false"
      requestBody:
        required: true
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        '200':
          description: File uploaded successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserDataResponseFull'
        '400':
          description: Missing or invalid 'file' parameter.
          content:
            text/plain:
              schema:
                type: string
        '401':
          description: Unauthorized.
          content:
            text/plain:
              schema:
                type: string
        '403':
          description: The requested path is not allowed.
          content:
            text/plain:
              schema:
                type: string
        '409':
          description: File already exists and overwrite is set to false.
          content:
            text/plain:
              schema:
                type: string
        '500':
          description: General error
          content:
            text/plain:
              schema:
                type: string
    delete:
      operationId: deleteUserdataFile
      summary: Delete a user data file
      description: |
        Delete a user data file from the database. The file parameter should be
        the relative path within the user's data directory.
      parameters:
        - name: file
          in: path
          required: true
          description: The file path to delete (URL encoded if necessary).
          schema:
            type: string
      responses:
        '204':
          description: File deleted successfully (No Content).
        '401':
          description: Unauthorized.
          content:
            text/plain:
              schema:
                type: string
        '404':
          description: File not found.
          content:
            text/plain:
              schema:
                type: string
        '500':
          description: Internal server error.
          content:
            text/plain:
              schema:
                type: string

  /api/upload/image:
    post:
      tags:
        - file
      summary: Upload an image file
      description: Upload an image file to cloud storage
      operationId: uploadImage
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - image
              properties:
                image:
                  type: string
                  format: binary
                  description: The image file to upload
                overwrite:
                  type: string
                  description: Whether to overwrite existing file (true/false)
                subfolder:
                  type: string
                  description: Optional subfolder path
                type:
                  type: string
                  description: Upload type (defaults to "output")
      responses:
        '200':
          description: Image uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                    description: Filename of the uploaded image
                  subfolder:
                    type: string
                    description: Subfolder path where image was saved
                  type:
                    type: string
                    description: Type of upload (e.g., "output")
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/upload/mask:
    post:
      tags:
        - file
      summary: Upload a mask image
      description: Upload a mask image to be applied to an existing image
      operationId: uploadMask
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - image
                - original_ref
              properties:
                image:
                  type: string
                  format: binary
                  description: The mask image file to upload
                original_ref:
                  type: string
                  description: JSON string containing reference to the original image
      responses:
        '200':
          description: Mask uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                    description: Filename of the uploaded mask
                  subfolder:
                    type: string
                    description: Subfolder path where mask was saved
                  type:
                    type: string
                    description: Type of upload (e.g., "output")
                  metadata:
                    type: object
                    description: Additional metadata for mask detection and re-editing
                    properties:
                      is_mask:
                        type: boolean
                        description: Whether this file is a mask
                      original_hash:
                        type: string
                        description: Hash of the original unmasked image
                      mask_type:
                        type: string
                        description: Type of mask (e.g., "painted_masked")
                      related_files:
                        type: object
                        description: Related mask layer files (if available)
                        properties:
                          mask:
                            type: string
                            description: Hash of the mask layer
                          paint:
                            type: string
                            description: Hash of the paint layer
                          painted:
                            type: string
                            description: Hash of the painted image
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /internal/logs:
    get:
      tags:
        - system
      summary: Get system logs
      description: Returns system logs for debugging purposes
      operationId: getLogs
      x-internal: true  # Excluded from public SDK generation
      security: []  # Public endpoint
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogsResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /internal/logs/raw:
    get:
      tags:
        - system
      summary: Get raw system logs
      description: Returns raw system logs without formatting
      operationId: getRawLogs
      x-internal: true  # Excluded from public SDK generation
      security: []  # Public endpoint
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RawLogsResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /internal/logs/subscribe:
    patch:
      tags:
        - system
      summary: Subscribe or unsubscribe from logs
      description: Enable or disable log subscription for a client
      operationId: subscribeToLogs
      x-internal: true  # Excluded from public SDK generation
      security: []  # Public endpoint
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogsSubscribeRequest'
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  enabled:
                    type: boolean
                    description: Whether logs subscription is enabled
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/system_stats:
    get:
      tags:
        - system
      summary: Get system statistics
      description: Returns system statistics including ComfyUI version, device info, and system resources
      operationId: getSystemStats
      security: []  # Public endpoint
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemStatsResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/session:
    post:
      tags:
        - auth
      summary: Create a session cookie
      description: |
        Creates a session cookie from the Firebase ID token in the Authorization header.
        Returns a Set-Cookie header with a secure, HttpOnly session cookie that expires in 2 hours.
        A new session cookie is created on every call.

        Authentication: Requires Authorization header with Bearer token or API key.
        Cookie authentication is not allowed for this endpoint.
      operationId: createSession
      security:
        - ApiKeyAuth: []
        - BearerAuth: []
      responses:
        '200':
          description: Session created successfully
          headers:
            Set-Cookie:
              description: Session cookie with 2-hour expiration
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateSessionResponse'
        '400':
          description: Bad request - Invalid or old ID token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized - Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags:
        - auth
      summary: Delete session cookie (logout)
      description: |
        Clears the session cookie and optionally revokes the session on the server.
        This logs the user out of their current session.
      operationId: deleteSession
      security: []  # Public endpoint - user might have expired session
      responses:
        '200':
          description: Session deleted successfully
          headers:
            Set-Cookie:
              description: Session cookie cleared (Max-Age=-1)
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteSessionResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/token:
    post:
      tags:
        - auth
      summary: Exchange Firebase JWT for Cloud JWT
      description: |
        Exchanges a Firebase JWT for a workspace-scoped Cloud JWT.
        If workspace_id is omitted, returns a token for the user's personal workspace.
      operationId: exchangeToken
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExchangeTokenRequest'
      responses:
        '200':
          description: Token exchanged successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExchangeTokenResponse'
        '401':
          description: Invalid or expired Firebase JWT
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Workspace not found or user not a member
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /.well-known/jwks.json:
    get:
      tags:
        - auth
      summary: Get JSON Web Key Set
      description: Public keys for validating Cloud JWTs
      operationId: getJwks
      security: []
      responses:
        '200':
          description: JWKS response
          headers:
            Cache-Control:
              schema:
                type: string
              description: Caching directive (e.g., "public, max-age=86400")
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JwksResponse'

  /api/workspaces:
    get:
      tags:
        - workspaces
      summary: List user's workspaces
      description: Returns all workspaces the authenticated user is a member of
      operationId: listWorkspaces
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of workspaces
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListWorkspacesResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Feature not enabled for user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - workspaces
      summary: Create a team workspace
      description: Creates a new team workspace with the authenticated user as owner
      operationId: createWorkspace
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWorkspaceRequest'
      responses:
        '201':
          description: Workspace created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workspace'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Feature not enabled for user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/workspaces/{id}:
    get:
      tags:
        - workspaces
      summary: Get workspace details
      description: Returns details of a specific workspace
      operationId: getWorkspace
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Workspace ID (w-{uuid} format)
      responses:
        '200':
          description: Workspace details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workspace'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Workspace not found or user not a member
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    patch:
      tags:
        - workspaces
      summary: Update workspace
      description: Updates workspace properties. Requires owner role.
      operationId: updateWorkspace
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Workspace ID (w-{uuid} format)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateWorkspaceRequest'
      responses:
        '200':
          description: Workspace updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workspace'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Owner role required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Workspace not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - workspaces
      summary: Delete workspace
      description: |
        Soft deletes a workspace. Requires owner role.
        Cannot delete personal workspaces.
      operationId: deleteWorkspace
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Workspace ID (w-{uuid} format)
      responses:
        '204':
          description: Workspace deleted
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Owner role required or cannot delete personal workspace
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Workspace not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/workspace/members:
    get:
      tags:
        - workspaces
      summary: List workspace members
      description: |
        Returns paginated list of workspace members. Requires membership.
        The workspace is determined from the authenticated user's token.
      operationId: listWorkspaceMembers
      security:
        - BearerAuth: []
      parameters:
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Pagination offset (0-based)
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Maximum number of members to return
      responses:
        '200':
          description: List of members
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListMembersResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Not a member of this workspace
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Workspace not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/workspace/invites:
    get:
      tags:
        - workspaces
      summary: List pending invites
      description: |
        Returns all pending invites for a workspace. Requires owner role.
        The workspace is determined from the authenticated user's token.
      operationId: listWorkspaceInvites
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of pending invites
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListInvitesResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Owner role required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - workspaces
      summary: Create a workspace invite
      description: |
        Creates an invite for a new member. Requires owner role.
        The workspace is determined from the authenticated user's token.
      operationId: createWorkspaceInvite
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInviteRequest'
      responses:
        '201':
          description: Invite created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PendingInvite'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Owner role required or personal workspace (invites not allowed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Workspace not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Invite already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/invites/{token}/accept:
    post:
      tags:
        - workspaces
      summary: Accept a workspace invite
      description: Accepts an invite and adds the user as a member of the workspace.
      operationId: acceptWorkspaceInvite
      security:
        - BearerAuth: []
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
          description: Invite token
      responses:
        '200':
          description: Invite accepted, user is now a member
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AcceptInviteResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Email does not match invite
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Invite not found or expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Already a member of this workspace
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/workspace/leave:
    post:
      tags:
        - workspaces
      summary: Leave a workspace
      description: |
        Removes the current user from the workspace. Cannot leave as the only owner.
        The workspace is determined from the authenticated user's token.
      operationId: leaveWorkspace
      security:
        - BearerAuth: []
      responses:
        '204':
          description: Successfully left workspace
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Cannot leave as the only owner or cannot leave personal workspace
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Workspace not found or not a member
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/workspace/invites/{inviteId}:
    delete:
      tags:
        - workspaces
      summary: Revoke a workspace invite
      description: |
        Deletes a pending invite. Requires owner role.
        The workspace is determined from the authenticated user's token.
      operationId: revokeWorkspaceInvite
      security:
        - BearerAuth: []
      parameters:
        - name: inviteId
          in: path
          required: true
          schema:
            type: string
          description: Invite ID to revoke
      responses:
        '204':
          description: Invite revoked
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Owner role required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Workspace or invite not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/workspace/members/{userId}:
    delete:
      tags:
        - workspaces
      summary: Remove a member from workspace
      description: |
        Removes a member from the workspace. Requires owner role.
        The workspace is determined from the authenticated user's token.
      operationId: removeWorkspaceMember
      security:
        - BearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
          description: User ID to remove
      responses:
        '204':
          description: Member removed
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Owner role required or cannot remove yourself
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Workspace or member not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/user:
    get:
      tags:
        - user
      summary: Get current user information
      description: Returns information about the currently authenticated user
      operationId: getUser
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/invite_code/{code}/status:
    get:
      tags:
        - user
      summary: Get invite code status
      description: Returns the status of an invite code (whether it's claimed or expired)
      operationId: getInviteCodeStatus
      parameters:
        - in: path
          name: code
          required: true
          schema:
            type: string
          description: The invite code to check
      responses:
        '200':
          description: Success - invite code exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InviteCodeStatusResponse'
        '401':
          description: Unauthorized - Firebase authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Invite code not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/invite_code/{code}/claim:
    post:
      tags:
        - user
      summary: Claim an invite code
      description: Claims an invite code for the authenticated user, granting them access to the platform
      operationId: claimInviteCode
      parameters:
        - in: path
          name: code
          required: true
          schema:
            type: string
          description: The invite code to claim
      responses:
        '200':
          description: Success - invite code claimed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InviteCodeClaimResponse'
        '400':
          description: Bad request - invite code already claimed or expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized - Firebase authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Invite code not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/api/send_user_invite_email:
    post:
      tags:
        - admin
      summary: Send an invite email to a user
      description: Sends an invitation email to the specified email address (admin only)
      operationId: sendUserInviteEmail
      x-internal: true  # Excluded from public SDK generation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendUserInviteEmailRequest'
      responses:
        '200':
          description: Success - invite email sent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SendUserInviteEmailResponse'
        '400':
          description: Bad request - invalid email or parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/api/deletion_requests:
    get:
      tags:
        - admin
      summary: Get a deletion request
      description: Returns the deletion request details for a given firebase_id
      operationId: getDeletionRequest
      x-internal: true  # Excluded from public SDK generation
      parameters:
        - name: firebase_id
          in: query
          required: true
          description: The Firebase ID of the user
          schema:
            type: string
      responses:
        '200':
          description: Success - deletion request found
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DeletionRequest'
        '400':
          description: Bad request - invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Deletion request not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags:
        - admin
      summary: Create a deletion request
      description: Creates a deletion request for a user
      operationId: createDeletionRequest
      x-internal: true  # Excluded from public SDK generation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - firebase_id
              properties:
                firebase_id:
                  type: string
                  description: The Firebase ID of the user to delete
      responses:
        '201':
          description: Created - deletion request created or already exists
        '400':
          description: Bad request - invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/job/{job_id}/status:
    get:
      tags:
        - job
      summary: Get job status
      description: Returns the current status of a specific job by ID
      operationId: getJobStatus
      parameters:
        - name: job_id
          in: path
          required: true
          description: The unique ID of the job
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Success - Job status returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobStatusResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - job belongs to another user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/webhooks/csam:
    post:
      tags:
        - system
      summary: CSAM detection webhook callback
      description: |
        Receives asynchronous CSAM scan results from TheHive API.
        This endpoint is called by TheHive when a scan completes.
      operationId: handleCSAMWebhook
      security: []  # No authentication required - public webhook endpoint
      parameters:
        - name: asset_id
          in: query
          required: true
          description: The asset ID to update with scan results
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CSAMWebhookPayload'
      responses:
        '200':
          description: Success - Webhook processed
        '400':
          description: Invalid request or signature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized - Invalid signature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/tasks:
    get:
      tags:
        - task
      summary: List background tasks
      description: |
        Retrieve a paginated list of background tasks for the authenticated user.
        Supports filtering by task type, status, and creation time.
      operationId: listTasks
      parameters:
        - name: task_name
          in: query
          required: false
          description: Filter by task type name (exact match)
          schema:
            type: string
          example: model_upload
        - name: idempotency_key
          in: query
          required: false
          description: Filter by idempotency key (exact match). For best performance, specify task_name as well.
          schema:
            type: string
          example: "upload-model-abc123"
        - name: status
          in: query
          required: false
          description: Filter by one or more statuses (comma-separated)
          schema:
            type: string
          example: created,running
        - name: created_after
          in: query
          required: false
          description: Filter tasks created after this timestamp (RFC3339 format)
          schema:
            type: string
            format: date-time
          example: "2024-01-01T00:00:00Z"
        - name: created_before
          in: query
          required: false
          description: Filter tasks created before this timestamp (RFC3339 format)
          schema:
            type: string
            format: date-time
          example: "2024-12-31T23:59:59Z"
        - name: sort_order
          in: query
          required: false
          description: Sort direction (asc = ascending, desc = descending by create_time)
          schema:
            type: string
            enum: [asc, desc]
            default: desc
        - name: offset
          in: query
          required: false
          description: Pagination offset (0-based)
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: limit
          in: query
          required: false
          description: Maximum items per page (1-100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: Success - Tasks retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TasksListResponse'
        '401':
          description: Unauthorized - Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error - Invalid filter values
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/tasks/{task_id}:
    get:
      tags:
        - task
      summary: Get task details
      description: |
        Retrieve full details for a specific background task.
      operationId: getTask
      parameters:
        - name: task_id
          in: path
          required: true
          description: Task identifier (UUID)
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Success - Task details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        '401':
          description: Unauthorized - Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Task not found (also returned for ownership failures to avoid leaking task existence)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/billing/status:
    get:
      tags:
        - billing
      summary: Get billing status
      description: |
        Returns the current billing status for the workspace.
        Requires workspace-scoped authentication.
      operationId: getBillingStatus
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Billing status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BillingStatusResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Workspace not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/billing/balance:
    get:
      tags:
        - billing
      summary: Get credit balance
      description: |
        Returns the current credit balance for the workspace from Metronome.
        This is a GET endpoint that may occasionally write (to update has_funds status).
      operationId: getBillingBalance
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Credit balance
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BillingBalanceResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/billing/events:
    get:
      tags:
        - billing
      summary: Get billing events
      description: |
        Returns paginated billing events for the workspace.
        Events include subscription changes, payments, and credit adjustments.
      operationId: getBillingEvents
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number (1-indexed)
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Number of events per page
      responses:
        '200':
          description: Paginated billing events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BillingEventsResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/billing/plans:
    get:
      tags:
        - billing
      summary: Get available subscription plans
      description: |
        Returns all subscription plans with pricing and availability for the workspace.
        Availability indicates whether the workspace can subscribe to each plan.
      operationId: getBillingPlans
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Available plans with pricing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BillingPlansResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/billing/preview-subscribe:
    post:
      tags:
        - billing
      summary: Preview what will happen when subscribing to a plan
      description: |
        Returns a preview of the subscription transition including:
        - Cost to charge today (for upgrades/new subscriptions)
        - Cost at next billing period
        - Credits granted today (prorated for upgrades)
        - Credits granted at next billing period
        
        This endpoint does not execute any billing operations.
        Use it to show the user what will happen before they confirm.
      operationId: previewSubscribe
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PreviewSubscribeRequest'
      responses:
        '200':
          description: Subscription preview
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PreviewSubscribeResponse'
        '400':
          description: Invalid request (e.g., invalid plan slug, seats below minimum)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/billing/subscribe:
    post:
      tags:
        - billing
      summary: Subscribe to a billing plan
      description: |
        Subscribes the workspace to the specified plan. Flow depends on payment method:
        
        **If workspace has payment method:**
        - Creates subscription immediately
        - Returns status="subscribed" with effective_at timestamp
        
        **If workspace needs payment method:**
        - Creates scheduled subscription (status=scheduled)
        - Returns status="needs_payment_method" with payment_method_url
        - After payment method is added via checkout, subscription is finalized
        
        For existing subscriptions, this performs a plan change (upgrade/downgrade).
      operationId: subscribe
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubscribeRequest'
      responses:
        '200':
          description: Subscription created or payment method needed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscribeResponse'
        '400':
          description: Invalid request (e.g., invalid plan slug, incompatible plan)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/billing/subscription/cancel:
    post:
      tags:
        - billing
      summary: Cancel the current subscription
      description: |
        Cancels the workspace's active subscription at the end of the current billing period.
        The subscription remains active until the period ends, then transitions to ended.
        
        Returns the date when the subscription will end.
      operationId: cancelSubscription
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelSubscriptionRequest'
      responses:
        '200':
          description: Subscription cancellation scheduled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CancelSubscriptionResponse'
        '400':
          description: Invalid request (e.g., no active subscription)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/billing/subscription/resubscribe:
    post:
      tags:
        - billing
      summary: Resubscribe (undo cancel) before period ends
      description: |
        Reverses a scheduled subscription cancellation before the period ends.
        If the subscription has a cancel_at date set (scheduled to cancel at period end),
        this clears the cancellation and resumes the subscription.
        
        This operation:
        1. Clears the cancel_at date on the subscription
        2. Sets subscription status back to active
        3. Clears the ending_before on the Metronome recurring commit
        
        Can only be called while the subscription is still in the cancellation grace period
        (before the period ends). After period end, you must subscribe again.
      operationId: resubscribe
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResubscribeRequest'
      responses:
        '200':
          description: Subscription resumed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResubscribeResponse'
        '400':
          description: Invalid request (e.g., no active subscription, not in cancellation grace period)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/billing/payment-portal:
    post:
      tags:
        - billing
      summary: Get payment portal URL
      description: |
        Returns a Stripe Billing Portal URL for managing payment methods.
        The user can add, update, or remove payment methods in the portal.
      operationId: getPaymentPortal
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentPortalRequest'
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentPortalResponse'
        '400':
          description: Bad request (e.g., missing return_url)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/billing/topup:
    post:
      tags:
        - billing
      summary: Create a credit top-up
      description: |
        Initiates a credit top-up for the workspace. Creates a payment-gated prepaid commit
        in Metronome that triggers an immediate Stripe charge. Credits are held until
        payment completes.
        
        Requires the workspace to have a valid payment method on file. If no payment method
        exists, returns an error directing the user to add one via the payment portal.
        
        The response includes a topup_id that can be used to poll for status via
        GET /api/billing/topup/{id}.
      operationId: createTopup
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTopupRequest'
      responses:
        '200':
          description: Top-up initiated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateTopupResponse'
        '400':
          description: Bad request (invalid amount, no payment method)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/billing/topup/{id}:
    get:
      tags:
        - billing
      summary: Get top-up status
      description: |
        Returns the current status of a credit top-up request.
        
        Status values:
        - pending: Payment is being processed
        - completed: Payment succeeded, credits granted
        - failed: Payment failed, see error_message for details
        
        Poll this endpoint after creating a top-up to track payment completion.
      operationId: getTopupStatus
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: The top-up ID returned from POST /api/billing/topup
          schema:
            type: string
      responses:
        '200':
          description: Top-up status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TopupStatusResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Top-up not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/billing/ops/{id}:
    get:
      tags:
        - billing
      summary: Get billing operation status
      description: |
        Returns the current status of a billing operation.
        
        All billing mutations (subscribe, cancel, topup, plan change) return a billing_op_id.
        Use this endpoint to poll for completion status.
        
        Status values:
        - pending: Operation is in progress
        - succeeded: Operation completed successfully
        - failed: Operation failed, see error_message for details
      operationId: getBillingOpStatus
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: The billing operation ID
          schema:
            type: string
      responses:
        '200':
          description: Billing operation status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BillingOpStatusResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Billing operation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/webhooks/stripe:
    post:
      tags:
        - billing
      summary: Stripe webhook endpoint
      description: |
        Receives billing events from Stripe.
        Signature is verified using the Stripe-Signature header.

        Handled events:
        - invoice.paid: Sets billing_status='paid'
      operationId: handleStripeWebhook
      security: []
      parameters:
        - name: Stripe-Signature
          in: header
          required: true
          description: Stripe webhook signature containing timestamp and signatures (t=...,v1=...,v0=...)
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Stripe webhook event payload
      responses:
        '200':
          description: Webhook processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid or missing signature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/webhooks/metronome:
    post:
      tags:
        - billing
      summary: Metronome webhook endpoint
      description: |
        Receives billing events from Metronome.
        Signature is verified using HMAC-SHA256 with the Metronome-Webhook-Signature header.

        Handled events:
        - alerts.low_remaining_commit_balance_reached: Sets has_funds=false
      operationId: handleMetronomeWebhook
      security: []
      parameters:
        - name: Metronome-Webhook-Signature
          in: header
          required: true
          description: HMAC-SHA256 signature of the webhook payload
          schema:
            type: string
        - name: Date
          in: header
          required: true
          description: RFC 1123 formatted timestamp of the request
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Metronome webhook event payload (schema varies by event type)
              additionalProperties: true
      responses:
        '200':
          description: Webhook processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid or missing signature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        API key authentication. Keys are prefixed with 'comfyui-' and can be
        generated from user account settings. Example: 'comfyui-abc123...'
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Firebase JWT token authentication. Obtain a token by authenticating
        with Firebase and pass it in the Authorization header.
    CookieAuth:
      type: apiKey
      in: cookie
      name: session
      description: |
        Session cookie authentication. Set automatically after successful
        login via the /api/auth/session endpoint.
  schemas:
    PromptRequest:
      type: object
      required:
        - prompt
      properties:
        prompt:
          type: object
          description: The workflow graph to execute
          additionalProperties: true
        number:
          type: number
          description: Priority number for the queue (lower numbers have higher priority)
        front:
          type: boolean
          description: If true, adds the prompt to the front of the queue
        extra_data:
          type: object
          description: Extra data to be associated with the prompt
          additionalProperties: true
        partial_execution_targets:
          type: array
          items:
            type: string
          description: List of node names to execute

    PromptResponse:
      type: object
      properties:
        prompt_id:
          type: string
          format: uuid
          description: Unique identifier for the prompt execution
        number:
          type: number
          description: Priority number in the queue
        node_errors:
          type: object
          description: Any errors in the nodes of the prompt
          additionalProperties: true

    ErrorResponse:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
        message:
          type: string

    ExportDownloadURLResponse:
      type: object
      required:
        - url
      properties:
        url:
          type: string
          description: Signed URL for downloading the export ZIP file
        expires_at:
          type: string
          format: date-time
          description: When the signed URL expires

    CSAMWebhookPayload:
      type: object
      description: TheHive async API webhook callback payload
      required:
        - id
      properties:
        id:
          type: string
          description: Unique identifier for the CSAM scan task
        project_id:
          type: integer
          description: TheHive project ID
        from_cache:
          type: boolean
          description: Whether result came from cache
        error:
          type: string
          description: Error message if the scan failed
        error_code:
          type: integer
          description: Error code if the scan failed (e.g., 3000 for classification error)
        status:
          type: array
          description: Array of status results (TheHive returns array for async tasks)
          items:
            $ref: '#/components/schemas/CSAMWebhookStatusItem'

    CSAMWebhookStatusItem:
      type: object
      description: Individual status result from TheHive
      properties:
        status:
          type: object
          properties:
            code:
              type: integer
              description: HTTP-like status code (200 = success)
            message:
              type: string
              description: Status message (e.g., "SUCCESS")
        response:
          type: object
          properties:
            output:
              type: object
              properties:
                hashes:
                  type: array
                  description: Array of matched hash records (empty if no match)
                  items:
                    $ref: '#/components/schemas/CSAMHashMatch'

    CSAMHashMatch:
      type: object
      description: A CSAM hash match from TheHive
      properties:
        hash_type:
          type: string
          description: Type of hash matched (e.g., "pdq", "md5")
        match_distance:
          type: integer
          description: Dissimilarity measure (0 = exact match)

    PromptInfo:
      type: object
      properties:
        exec_info:
          type: object
          properties:
            queue_remaining:
              type: integer
              description: Number of items remaining in the queue

    NodeInfo:
      type: object
      properties:
        input:
          type: object
          description: Input specifications for the node
          additionalProperties: true
        input_order:
          type: object
          description: Order of inputs for display
          additionalProperties:
            type: array
            items:
              type: string
        output:
          type: array
          items:
            type: string
          description: Output types of the node
        output_is_list:
          type: array
          items:
            type: boolean
          description: Whether each output is a list
        output_name:
          type: array
          items:
            type: string
          description: Names of the outputs
        name:
          type: string
          description: Internal name of the node
        display_name:
          type: string
          description: Display name of the node
        description:
          type: string
          description: Description of the node
        python_module:
          type: string
          description: Python module implementing the node
        category:
          type: string
          description: Category of the node
        output_node:
          type: boolean
          description: Whether this is an output node
        output_tooltips:
          type: array
          items:
            type: string
          description: Tooltips for outputs
        deprecated:
          type: boolean
          description: Whether the node is deprecated
        experimental:
          type: boolean
          description: Whether the node is experimental
        api_node:
          type: boolean
          description: Whether this is an API node

    GlobalSubgraphInfo:
      type: object
      description: Metadata for a global subgraph blueprint (without full data)
      required:
        - source
        - name
        - info
      properties:
        source:
          type: string
          description: Source type of the subgraph - "templates" for workflow templates or "custom_node" for custom node subgraphs
        name:
          type: string
          description: Display name of the subgraph blueprint
        info:
          type: object
          description: Additional information about the subgraph
          required:
            - node_pack
          properties:
            node_pack:
              type: string
              description: The node pack/module that provides this subgraph
        data:
          type: string
          description: The full subgraph JSON data (may be empty in list view)

    GlobalSubgraphData:
      type: object
      description: Full data for a global subgraph blueprint
      required:
        - source
        - name
        - info
        - data
      properties:
        source:
          type: string
          description: Source type of the subgraph - "templates" for workflow templates or "custom_node" for custom node subgraphs
        name:
          type: string
          description: Display name of the subgraph blueprint
        info:
          type: object
          description: Additional information about the subgraph
          required:
            - node_pack
          properties:
            node_pack:
              type: string
              description: The node pack/module that provides this subgraph
        data:
          type: string
          description: The full subgraph JSON data as a string

    HistoryResponse:
      type: object
      description: |
        Execution history response with history array.
        Returns an object with a "history" key containing an array of history entries.
        Each entry includes prompt_id as a property along with execution data.
      required:
        - history
      properties:
        history:
          type: array
          description: Array of history entries ordered by creation time (newest first)
          items:
            $ref: '#/components/schemas/HistoryEntry'

    HistoryEntry:
      type: object
      description: History entry with prompt_id and execution data
      required:
        - prompt_id
      properties:
        prompt_id:
          type: string
          description: Unique identifier for this prompt execution
        create_time:
          type: integer
          format: int64
          description: Job creation timestamp (Unix timestamp in milliseconds)
        workflow_id:
          type: string
          description: UUID identifying the workflow graph definition
        prompt:
          type: object
          description: Filtered prompt execution data (lightweight format)
          properties:
            priority:
              type: number
              format: double
              description: Execution priority
            prompt_id:
              type: string
              description: The prompt ID
            extra_data:
              type: object
              description: Additional execution data (workflow removed from extra_pnginfo)
              additionalProperties: true
        outputs:
          type: object
          description: Output data from execution (generated images, files, etc.)
          additionalProperties: true
        status:
          type: object
          description: Execution status and timeline information
          additionalProperties: true
        meta:
          type: object
          description: Metadata about the execution and nodes
          additionalProperties: true

    HistoryDetailEntry:
      type: object
      description: History entry with full prompt data
      properties:
        prompt:
          type: object
          description: Full prompt execution data
          properties:
            priority:
              type: number
              format: double
              description: Execution priority
            prompt_id:
              type: string
              description: The prompt ID
            prompt:
              type: object
              description: The workflow nodes
              additionalProperties: true
            extra_data:
              type: object
              description: Additional execution data
              additionalProperties: true
            outputs_to_execute:
              type: array
              items:
                type: string
              description: Output nodes to execute
        outputs:
          type: object
          description: Output data from execution (generated images, files, etc.)
          additionalProperties: true
        status:
          type: object
          description: Execution status and timeline information
          additionalProperties: true
        meta:
          type: object
          description: Metadata about the execution and nodes
          additionalProperties: true

    HistoryDetailResponse:
      type: object
      description: |
        Detailed execution history response for a specific prompt.
        Returns a dictionary with prompt_id as key and full history data as value.
      additionalProperties:
        $ref: '#/components/schemas/HistoryDetailEntry'

    QueueInfo:
      type: object
      description: Queue information with pending and running jobs
      properties:
        queue_running:
          type: array
          description: Array of currently running job items
          items:
            type: array
            description: |
              Queue item tuple format: [job_number, prompt_id, workflow_json, output_node_ids, metadata]
              - [0] job_number (integer): Position in queue (1-based)
              - [1] prompt_id (string): Job UUID
              - [2] workflow_json (object): Full ComfyUI workflow
              - [3] output_node_ids (array): Node IDs to return results from
              - [4] metadata (object): Contains {create_time: <milliseconds>}
        queue_pending:
          type: array
          description: Array of pending job items (ordered by creation time, oldest first)
          items:
            type: array
            description: |
              Queue item tuple format: [job_number, prompt_id, workflow_json, output_node_ids, metadata]
              - [0] job_number (integer): Position in queue (1-based)
              - [1] prompt_id (string): Job UUID
              - [2] workflow_json (object): Full ComfyUI workflow
              - [3] output_node_ids (array): Node IDs to return results from
              - [4] metadata (object): Contains {create_time: <milliseconds>}

    QueueManageRequest:
      type: object
      description: Request to manage queue operations
      properties:
        delete:
          type: array
          items:
            type: string
          description: Array of PENDING job IDs to cancel
        clear:
          type: boolean
          description: If true, clear all pending jobs from the queue
      additionalProperties: false

    QueueManageResponse:
      type: object
      properties:
        deleted:
          type: array
          items:
            type: string
          description: Array of job IDs that were successfully cancelled
        cleared:
          type: boolean
          description: Whether the queue was cleared

    JobStatusResponse:
      type: object
      description: Job status information
      properties:
        id:
          type: string
          format: uuid
          description: The job ID
        status:
          type: string
          enum: [waiting_to_dispatch, pending, in_progress, completed, error, cancelled]
          description: Current job status
        created_at:
          type: string
          format: date-time
          description: When the job was created
        updated_at:
          type: string
          format: date-time
          description: When the job was last updated
        last_state_update:
          type: string
          format: date-time
          description: When the job status was last changed
        assigned_inference:
          type: string
          nullable: true
          description: The inference instance assigned to this job (if any)
        error_message:
          type: string
          nullable: true
          description: Error message if the job failed
      required:
        - id
        - status
        - created_at
        - updated_at

    HistoryManageRequest:
      type: object
      description: Request to manage history operations
      properties:
        delete:
          type: array
          items:
            type: string
          description: Array of job IDs to delete from history
        clear:
          type: boolean
          description: If true, clear all history for the authenticated user
      additionalProperties: false
    UserDataResponse:
      oneOf:
        - $ref: '#/components/schemas/UserDataResponseFull'
        - $ref: '#/components/schemas/UserDataResponseShort'
    UserDataResponseFull:
      type: object
      properties:
        path:
          type: string
        size:
          type: integer
        modified:
          type: string
          format: date-time
    UserDataResponseShort:
      type: string
    GetUserDataResponseFull:
      type: array
      items:
        $ref: '#/components/schemas/GetUserDataResponseFullFile'

    GetUserDataResponseFullFile:
      type: object
      properties:
        path:
          type: string
          description: File name or path relative to the user directory.
        size:
          type: integer
          description: File size in bytes.
        modified:
          type: number
          format: float
          description: UNIX timestamp of the last modification.
    PromptErrorResponse:
      type: object
      description: Error response for ComfyUI prompt execution.
      additionalProperties: true

    ModelFolder:
      type: object
      description: Represents a folder containing models
      required:
        - name
        - folders
      properties:
        name:
          type: string
          description: The name of the model folder
          example: "checkpoints"
        folders:
          type: array
          items:
            type: string
          description: List of paths where models of this type are stored
          example: ["checkpoints"]

    ModelFile:
      type: object
      description: Represents a model file with metadata
      required:
        - name
        - pathIndex
      properties:
        name:
          type: string
          description: The filename of the model
          example: "model.safetensors"
        pathIndex:
          type: integer
          description: Index of the path where this model is located
          example: 0

    FeedbackRequest:
      type: object
      description: Request to submit user feedback
      required:
        - type
      properties:
        type:
          type: string
          enum: [missing_nodes, general, missing_models]
          description: Type of feedback being submitted
        content:
          type: string
          description: The feedback content or message
        rating:
          type: integer
          minimum: 1
          maximum: 5
          description: User's rating of ComfyUI Cloud experience (1-5 stars)
        metadata:
          type: object
          description: Additional metadata about the feedback
          additionalProperties: true

    FeedbackResponse:
      type: object
      description: Response after submitting feedback
      properties: {}

    LogsResponse:
      type: array
      description: System logs response
      items:
        type: object
        properties:
          timestamp:
            type: string
            format: date-time
            description: When the log entry was created
          level:
            type: string
            enum: [debug, info, warn, error]
            description: Log level
          message:
            type: string
            description: Log message
          source:
            type: string
            description: Source of the log entry
          metadata:
            type: object
            additionalProperties: true
            description: Additional log metadata

    RawLogsResponse:
      type: object
      description: Raw logs response with entries and size
      properties:
        entries:
          type: array
          items:
            type: object
            properties:
              m:
                type: string
                description: Log message
        size:
          type: object
          properties:
            cols:
              type: integer
              description: Terminal column size
            rows:
              type: integer
              description: Terminal row size

    LogsSubscribeRequest:
      type: object
      required:
        - enabled
      properties:
        enabled:
          type: boolean
          description: Whether to enable or disable log subscription

    SystemStatsResponse:
      type: object
      description: System statistics response
      required:
        - system
        - devices
      properties:
        system:
          type: object
          required:
            - os
            - python_version
            - embedded_python
            - comfyui_version
            - pytorch_version
            - argv
            - ram_total
            - ram_free
          properties:
            os:
              type: string
              description: Operating system
            python_version:
              type: string
              description: Python version
            embedded_python:
              type: boolean
              description: Whether using embedded Python
            comfyui_version:
              type: string
              description: ComfyUI version
            comfyui_frontend_version:
              type: string
              description: ComfyUI frontend version (commit hash or tag)
            workflow_templates_version:
              type: string
              description: Workflow templates version
            cloud_version:
              type: string
              description: Cloud ingest service version (commit hash)
            pytorch_version:
              type: string
              description: PyTorch version
            argv:
              type: array
              items:
                type: string
              description: Command line arguments
            ram_total:
              type: number
              description: Total RAM in bytes
            ram_free:
              type: number
              description: Free RAM in bytes
        devices:
          type: array
          items:
            type: object
            required:
              - name
              - type
            properties:
              name:
                type: string
                description: Device name
              type:
                type: string
                description: Device type
              vram_total:
                type: number
                description: Total VRAM in bytes
              vram_free:
                type: number
                description: Free VRAM in bytes

    UserResponse:
      type: object
      description: User information response
      required:
        - status
      properties:
        status:
          type: string
          description: User status (active or waitlisted)

    CreateSessionRequest:
      type: object
      description: Request to create a session cookie from a Firebase ID token
      required:
        - idToken
      properties:
        idToken:
          type: string
          description: Firebase ID token from the client

    CreateSessionResponse:
      type: object
      description: Response after creating a session cookie
      required:
        - success
      properties:
        success:
          type: boolean
          description: Whether the session was created successfully
        expiresIn:
          type: integer
          description: Session expiration time in seconds (5 days)

    DeleteSessionResponse:
      type: object
      description: Response after deleting a session cookie
      required:
        - success
      properties:
        success:
          type: boolean
          description: Whether the session was deleted successfully

    InviteCodeStatusResponse:
      type: object
      description: Invite code status response
      required:
        - claimed
        - expired
      properties:
        claimed:
          type: boolean
          description: Whether the code has been claimed
        expired:
          type: boolean
          description: Whether the code has expired

    InviteCodeClaimResponse:
      type: object
      description: Response after successfully claiming an invite code
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          description: Whether the claim was successful
        message:
          type: string
          description: Success message

    SendUserInviteEmailRequest:
      type: object
      description: Request to send an invite email to a user
      required:
        - email
      properties:
        email:
          type: string
          description: The email address to send the invitation to
        force:
          type: boolean
          description: Whether to force send the invite even if user already exists or has been invited
          default: false

    SendUserInviteEmailResponse:
      type: object
      description: Response after sending an invite email
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          description: Whether the email was sent successfully
        message:
          type: string
          description: A message describing the result

    Asset:
      type: object
      required:
        - id
        - name
        - size
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the asset
        name:
          type: string
          description: Name of the asset file
        asset_hash:
          type: string
          description: Blake3 hash of the asset content
          pattern: '^blake3:[a-f0-9]{64}$'
        size:
          type: integer
          format: int64
          description: Size of the asset in bytes
        mime_type:
          type: string
          description: MIME type of the asset
        tags:
          type: array
          items:
            type: string
          description: Tags associated with the asset
        user_metadata:
          type: object
          description: Custom user metadata for the asset
          additionalProperties: true
        metadata:
          type: object
          description: System-managed metadata from download sources (HuggingFace, CivitAI, etc.) - read-only, not user-modifiable
          additionalProperties: true
          readOnly: true
        preview_url:
          type: string
          format: uri
          description: URL for asset preview/thumbnail
        preview_id:
          type: string
          format: uuid
          description: ID of the preview asset if available
          nullable: true
        prompt_id:
          type: string
          format: uuid
          description: ID of the job/prompt that created this asset, if available
          nullable: true
        created_at:
          type: string
          format: date-time
          description: Timestamp when the asset was created
        updated_at:
          type: string
          format: date-time
          description: Timestamp when the asset was last updated
        last_access_time:
          type: string
          format: date-time
          description: Timestamp when the asset was last accessed
        is_immutable:
          type: boolean
          description: Whether this asset is immutable (cannot be modified or deleted)

    AssetCreated:
      allOf:
        - $ref: '#/components/schemas/Asset'
        - type: object
          required:
            - created_new
          properties:
            created_new:
              type: boolean
              description: Whether this was a new asset creation (true) or returned existing (false)

    AssetUpdated:
      type: object
      required:
        - id
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Asset ID
        name:
          type: string
          description: Updated name of the asset
        asset_hash:
          type: string
          description: Blake3 hash of the asset content
          pattern: '^blake3:[a-f0-9]{64}$'
        tags:
          type: array
          items:
            type: string
          description: Tags associated with the asset
        mime_type:
          type: string
          description: Updated MIME type of the asset
        user_metadata:
          type: object
          description: Updated custom metadata
          additionalProperties: true
        updated_at:
          type: string
          format: date-time
          description: Timestamp of the update

    ListAssetsResponse:
      type: object
      required:
        - assets
        - total
        - has_more
      properties:
        assets:
          type: array
          items:
            $ref: '#/components/schemas/Asset'
          description: List of assets matching the query
        total:
          type: integer
          description: Total number of assets matching the filters
        has_more:
          type: boolean
          description: Whether more assets are available beyond this page

    TagInfo:
      type: object
      required:
        - name
        - count
      properties:
        name:
          type: string
          description: Tag name
        count:
          type: integer
          description: Number of assets using this tag

    ListTagsResponse:
      type: object
      required:
        - tags
        - total
        - has_more
      properties:
        tags:
          type: array
          items:
            $ref: '#/components/schemas/TagInfo'
          description: List of tags
        total:
          type: integer
          description: Total number of tags
        has_more:
          type: boolean
          description: Whether more tags are available

    AssetTagHistogramResponse:
      type: object
      required:
        - tag_counts
      properties:
        tag_counts:
          type: object
          additionalProperties:
            type: integer
          description: Map of tag names to their occurrence counts on matching assets
          example:
            checkpoint: 32
            lora: 193
            vae: 6

    AssetMetadataResponse:
      type: object
      required:
        - content_length
      properties:
        content_length:
          type: integer
          format: int64
          description: Size of the asset in bytes (-1 if unknown)
          example: 4294967296
        content_type:
          type: string
          description: MIME type of the asset
          example: "application/octet-stream"
        filename:
          type: string
          description: Suggested filename for the asset from source
          example: "realistic-vision-v5.safetensors"
        name:
          type: string
          description: Display name or title for the asset from source
          example: "Realistic Vision v5.0"
        tags:
          type: array
          items:
            type: string
          description: Tags for categorization from source
          example: ["models", "checkpoint"]
        preview_image:
          type: string
          description: Preview image as base64-encoded data URL
          example: "data:image/jpeg;base64,/9j/4AAQSkZJRg..."
        validation:
          $ref: '#/components/schemas/ValidationResult'
          description: Validation results for the file

    AssetDownloadResponse:
      type: object
      required:
        - task_id
        - status
      properties:
        task_id:
          type: string
          format: uuid
          description: Task ID for tracking download progress via GET /api/tasks/{task_id}
        status:
          type: string
          enum: [created, running, completed, failed]
          description: Current task status
        message:
          type: string
          description: Human-readable message
          example: "Download task created. Use task_id to track progress."

    ValidationResult:
      type: object
      required:
        - is_valid
      properties:
        is_valid:
          type: boolean
          description: Overall validation status (true if all checks passed)
          example: true
        errors:
          type: array
          items:
            $ref: '#/components/schemas/ValidationError'
          description: Blocking validation errors that prevent download
        warnings:
          type: array
          items:
            $ref: '#/components/schemas/ValidationError'
          description: Non-blocking validation warnings (informational only)

    ValidationError:
      type: object
      required:
        - code
        - message
        - field
      properties:
        code:
          type: string
          description: Machine-readable error code
          example: FORMAT_NOT_ALLOWED
        message:
          type: string
          description: Human-readable error message
          example: "File format \"PickleTensor\" is not allowed. Allowed formats: [SafeTensor]"
        field:
          type: string
          description: Field that failed validation
          example: format

    TagsModificationResponse:
      type: object
      required:
        - total_tags
      properties:
        added:
          type: array
          items:
            type: string
          description: Tags that were successfully added (for add operation)
        removed:
          type: array
          items:
            type: string
          description: Tags that were successfully removed (for remove operation)
        already_present:
          type: array
          items:
            type: string
          description: Tags that were already present (for add operation)
        not_present:
          type: array
          items:
            type: string
          description: Tags that were not present (for remove operation)
        total_tags:
          type: array
          items:
            type: string
          description: All tags on the asset after the operation

    # Jobs API Schemas
    JobsListResponse:
      type: object
      required:
        - jobs
        - pagination
      properties:
        jobs:
          type: array
          description: Array of jobs ordered by specified sort field
          items:
            $ref: '#/components/schemas/JobEntry'
        pagination:
          $ref: '#/components/schemas/PaginationInfo'

    JobEntry:
      type: object
      description: Lightweight job data for list views (workflow and full outputs excluded)
      required:
        - id
        - status
        - create_time
      properties:
        id:
          type: string
          format: uuid
          description: Unique job identifier
        status:
          type: string
          enum: [pending, in_progress, completed, failed, cancelled]
          description: User-friendly job status
        execution_error:
          $ref: '#/components/schemas/ExecutionError'
          description: Detailed execution error from ComfyUI (only for failed jobs with structured error data)
        create_time:
          type: integer
          format: int64
          description: Job creation timestamp (Unix timestamp in seconds)
        preview_output:
          type: object
          description: Primary preview output (only present for terminal states)
          additionalProperties: true
        outputs_count:
          type: integer
          description: Total number of output files (omitted for non-terminal states)
        workflow_id:
          type: string
          description: UUID identifying the workflow graph definition
        execution_start_time:
          type: integer
          format: int64
          description: Workflow execution start timestamp (Unix milliseconds, only present for terminal states)
        execution_end_time:
          type: integer
          format: int64
          description: Workflow execution completion timestamp (Unix milliseconds, only present for terminal states)

    JobDetailResponse:
      type: object
      description: Full job details including workflow and outputs
      required:
        - id
        - status
        - create_time
        - update_time
      properties:
        id:
          type: string
          format: uuid
          description: Unique job identifier
        status:
          type: string
          enum: [pending, in_progress, completed, failed, cancelled]
          description: User-friendly job status
        workflow:
          type: object
          description: Full ComfyUI workflow (10-100KB, omitted if not available)
          additionalProperties: true
        execution_error:
          $ref: '#/components/schemas/ExecutionError'
          description: Detailed execution error from ComfyUI (only for failed jobs with structured error data)
        create_time:
          type: integer
          format: int64
          description: Job creation timestamp (Unix timestamp in seconds)
        update_time:
          type: integer
          format: int64
          description: Last update timestamp (Unix timestamp in seconds)
        outputs:
          type: object
          description: Full outputs object from ComfyUI (only for terminal states)
          additionalProperties: true
        preview_output:
          type: object
          description: Primary preview output (only for terminal states)
          additionalProperties: true
        outputs_count:
          type: integer
          description: Total number of output files (omitted for non-terminal states)
        workflow_id:
          type: string
          description: UUID identifying the workflow graph definition
        execution_status:
          type: object
          description: ComfyUI execution status and timeline (only for terminal states)
          additionalProperties: true
        execution_meta:
          type: object
          description: Node-level execution metadata (only for terminal states)
          additionalProperties: true

    ExecutionError:
      type: object
      description: Detailed execution error information from ComfyUI
      required:
        - node_id
        - node_type
        - exception_message
        - exception_type
        - traceback
        - current_inputs
        - current_outputs
      properties:
        node_id:
          type: string
          description: ID of the node that failed
        node_type:
          type: string
          description: Type name of the node (e.g., "KSampler")
        exception_message:
          type: string
          description: Human-readable error message
        exception_type:
          type: string
          description: Python exception type (e.g., "RuntimeError")
        traceback:
          type: array
          items:
            type: string
          description: Array of traceback lines (empty array if not available)
        current_inputs:
          type: object
          additionalProperties: true
          description: Input values at time of failure (empty object if not available)
        current_outputs:
          type: object
          additionalProperties: true
          description: Output values at time of failure (empty object if not available)

    PaginationInfo:
      type: object
      required:
        - offset
        - limit
        - total
        - has_more
      properties:
        offset:
          type: integer
          minimum: 0
          description: Current offset (0-based)
        limit:
          type: integer
          minimum: 1
          description: Items per page
        total:
          type: integer
          minimum: 0
          description: Total number of items matching filters
        has_more:
          type: boolean
          description: Whether more items are available beyond this page

    DeletionStatus:
      type: object
      required:
        - status_name
        - status_details
      properties:
        status_name:
          type: string
          description: The name of the deletion status
        status_details:
          type: string
          description: Additional details about the deletion status

    DeletionRequest:
      type: object
      required:
        - id
        - firebase_id
        - create_time
        - deletion_status
      properties:
        id:
          type: string
          description: Unique identifier for the deletion request
        firebase_id:
          type: string
          description: The Firebase ID of the user being deleted
        create_time:
          type: string
          format: date-time
          description: The time the deletion request was created
        deletion_status:
          type: array
          description: Array of deletion status objects
          items:
            $ref: '#/components/schemas/DeletionStatus'

    # Task API Schemas
    TasksListResponse:
      type: object
      required:
        - tasks
        - pagination
      properties:
        tasks:
          type: array
          description: Array of tasks ordered by create_time
          items:
            $ref: '#/components/schemas/TaskEntry'
        pagination:
          $ref: '#/components/schemas/PaginationInfo'

    TaskEntry:
      type: object
      description: Task data for list views
      required:
        - id
        - task_name
        - status
        - create_time
      properties:
        id:
          type: string
          format: uuid
          description: Unique task identifier
        task_name:
          type: string
          description: Task type name (e.g., model_upload)
        status:
          type: string
          enum: [created, running, completed, failed]
          description: Current task status
        create_time:
          type: string
          format: date-time
          description: Task creation timestamp
        started_at:
          type: string
          format: date-time
          description: When task execution started (null if not started)
        completed_at:
          type: string
          format: date-time
          description: When task completed or failed (null if not finished)

    TaskResponse:
      type: object
      description: Full task details including payload and result
      required:
        - id
        - idempotency_key
        - task_name
        - payload
        - status
        - create_time
        - update_time
      properties:
        id:
          type: string
          format: uuid
          description: Unique task identifier
        idempotency_key:
          type: string
          description: Caller-provided key for idempotent task creation
        task_name:
          type: string
          description: Task type name (e.g., model_upload)
        payload:
          type: object
          additionalProperties: true
          description: Task input data
        status:
          type: string
          enum: [created, running, completed, failed]
          description: Current task status
        result:
          type: object
          additionalProperties: true
          description: Task output data (null if not completed)
        error_message:
          type: string
          description: Error message on failure (null if not failed)
        create_time:
          type: string
          format: date-time
          description: Task creation timestamp
        update_time:
          type: string
          format: date-time
          description: Task last update timestamp
        started_at:
          type: string
          format: date-time
          description: When task execution started (null if not started)
        completed_at:
          type: string
          format: date-time
          description: When task completed or failed (null if not finished)

    ExchangeTokenRequest:
      type: object
      properties:
        workspace_id:
          type: string
          description: Workspace ID to get token for. Defaults to personal workspace if omitted.
          example: "w-a1b2c3d4-5678-90ab-cdef-1234567890ab"

    ExchangeTokenResponse:
      type: object
      required:
        - token
        - expires_at
        - workspace
        - role
        - permissions
      properties:
        token:
          type: string
          description: Cloud JWT token
        expires_at:
          type: string
          format: date-time
          description: Token expiration time (RFC 3339)
        workspace:
          $ref: '#/components/schemas/WorkspaceSummary'
        role:
          type: string
          enum: [owner, member]
          description: User's role in the workspace
        permissions:
          type: array
          items:
            type: string
          description: Permission strings for the role
          example: ["owner:*"]

    WorkspaceSummary:
      type: object
      required:
        - id
        - name
        - type
      properties:
        id:
          type: string
          example: "w-a1b2c3d4-5678-90ab-cdef-1234567890ab"
        name:
          type: string
          example: "My Team"
        type:
          type: string
          enum: [personal, team]

    Workspace:
      type: object
      required:
        - id
        - name
        - type
        - created_at
      properties:
        id:
          type: string
          example: "w-a1b2c3d4-5678-90ab-cdef-1234567890ab"
        name:
          type: string
          example: "My Team"
        type:
          type: string
          enum: [personal, team]
        created_at:
          type: string
          format: date-time

    ListWorkspacesResponse:
      type: object
      required:
        - workspaces
      properties:
        workspaces:
          type: array
          items:
            $ref: '#/components/schemas/WorkspaceWithRole'

    WorkspaceWithRole:
      type: object
      required:
        - id
        - name
        - type
        - role
      properties:
        id:
          type: string
          example: "w-a1b2c3d4-5678-90ab-cdef-1234567890ab"
        name:
          type: string
          example: "My Team"
        type:
          type: string
          enum: [personal, team]
        role:
          type: string
          enum: [owner, member]
        subscription_tier:
          $ref: '#/components/schemas/SubscriptionTier'

    CreateWorkspaceRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: Display name for the workspace
          minLength: 1
          maxLength: 100
          example: "My Team Workspace"

    UpdateWorkspaceRequest:
      type: object
      properties:
        name:
          type: string
          description: New display name for the workspace
          minLength: 1
          maxLength: 100
          example: "New Team Name"

    Member:
      type: object
      required:
        - id
        - name
        - email
        - role
        - joined_at
      properties:
        id:
          type: string
          description: User ID
        name:
          type: string
          description: User's display name
        email:
          type: string
          format: email
          description: User's email address
        role:
          type: string
          enum: [owner, member]
          description: User's role in the workspace
        joined_at:
          type: string
          format: date-time
          description: When the user joined the workspace

    ListMembersResponse:
      type: object
      required:
        - members
        - pagination
      properties:
        members:
          type: array
          items:
            $ref: '#/components/schemas/Member'
        pagination:
          $ref: '#/components/schemas/PaginationInfo'

    PendingInvite:
      type: object
      required:
        - id
        - email
        - invited_at
        - expires_at
      properties:
        id:
          type: string
          description: Invite ID
        email:
          type: string
          format: email
          description: Email address of the invited user
        token:
          type: string
          description: Invite token for constructing invite links. Empty for expired invites.
        invited_at:
          type: string
          format: date-time
          description: When the invite was created
        expires_at:
          type: string
          format: date-time
          description: When the invite expires

    ListInvitesResponse:
      type: object
      required:
        - invites
      properties:
        invites:
          type: array
          items:
            $ref: '#/components/schemas/PendingInvite'

    CreateInviteRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          description: Email address to invite

    AcceptInviteResponse:
      type: object
      required:
        - workspace_id
        - workspace_name
      properties:
        workspace_id:
          type: string
          description: ID of the workspace joined
        workspace_name:
          type: string
          description: Name of the workspace joined

    JwksResponse:
      type: object
      required:
        - keys
      properties:
        keys:
          type: array
          items:
            $ref: '#/components/schemas/JwkKey'

    JwkKey:
      type: object
      required:
        - kty
        - crv
        - kid
        - use
        - alg
        - x
        - "y"
      properties:
        kty:
          type: string
          example: "EC"
        crv:
          type: string
          example: "P-256"
        kid:
          type: string
          example: "cloud-jwt-key-1"
        use:
          type: string
          example: "sig"
        alg:
          type: string
          example: "ES256"
        x:
          type: string
          description: Base64url-encoded X coordinate
        "y":
          type: string
          description: Base64url-encoded Y coordinate

    # Billing schemas
    SubscriptionTier:
      type: string
      enum: [STANDARD, CREATOR, PRO, FOUNDERS_EDITION]
      description: Subscription tier (uppercase to match comfy-api)

    SubscriptionDuration:
      type: string
      enum: [MONTHLY, ANNUAL]
      description: Billing period (uppercase to match comfy-api)

    BillingStatus:
      type: string
      enum: [awaiting_payment_method, pending_payment, paid, payment_failed, inactive]
      description: Payment lifecycle status

    SubscriptionStatus:
      type: string
      enum: [active, scheduled, ended, canceled]
      description: Subscription activity status

    BillingStatusResponse:
      type: object
      required:
        - is_active
        - has_funds
      properties:
        is_active:
          type: boolean
          description: Whether the workspace has an active subscription
        subscription_status:
          type: string
          enum: [active, ended, canceled]
          description: Subscription activity status (scheduled subscriptions are not returned)
        subscription_tier:
          $ref: '#/components/schemas/SubscriptionTier'
        subscription_duration:
          $ref: '#/components/schemas/SubscriptionDuration'
        plan_slug:
          type: string
          description: Plan identifier (e.g., standard-monthly, team-pro-annual)
        billing_status:
          $ref: '#/components/schemas/BillingStatus'
        has_funds:
          type: boolean
          description: Whether the workspace has available credits
        cancel_at:
          type: string
          format: date-time
          description: When the subscription will become inactive (if canceled)

    BillingBalanceResponse:
      type: object
      required:
        - amount_micros
        - currency
      properties:
        amount_micros:
          type: number
          format: double
          description: The total remaining balance in microamount (1/1,000,000 of the currency unit)
        prepaid_balance_micros:
          type: number
          format: double
          description: The remaining balance from prepaid commits in microamount
        cloud_credit_balance_micros:
          type: number
          format: double
          description: The remaining balance from cloud credits in microamount
        pending_charges_micros:
          type: number
          format: double
          description: The total amount of pending/unbilled charges from draft invoices in microamount
        effective_balance_micros:
          type: number
          format: double
          description: The effective balance (total balance minus pending charges). Can be negative if pending charges exceed the balance.
        currency:
          type: string
          example: "usd"
          description: Currency code

    BillingEvent:
      type: object
      required:
        - event_type
        - event_id
        - createdAt
      properties:
        event_type:
          type: string
          description: Type of billing event (e.g., subscription.created, payment.succeeded)
        event_id:
          type: string
          description: Unique event identifier
        params:
          type: object
          additionalProperties: true
          description: Event-specific parameters
        createdAt:
          type: string
          format: date-time
          description: When the event occurred

    BillingEventsResponse:
      type: object
      required:
        - total
        - events
        - page
        - limit
        - totalPages
      properties:
        total:
          type: integer
          description: Total number of events
        events:
          type: array
          items:
            $ref: '#/components/schemas/BillingEvent'
        page:
          type: integer
          description: Current page number (1-indexed)
        limit:
          type: integer
          description: Items per page
        totalPages:
          type: integer
          description: Total number of pages

    # User Secrets schemas
    CreateSecretRequest:
      type: object
      required:
        - name
        - secret_value
      properties:
        name:
          type: string
          description: User-provided label for the secret
          minLength: 1
          maxLength: 255
        provider:
          type: string
          description: Optional provider identifier (e.g., huggingface, civitai)
          maxLength: 64
        secret_value:
          type: string
          description: The plaintext secret to encrypt and store
          minLength: 1

    UpdateSecretRequest:
      type: object
      properties:
        name:
          type: string
          description: New name for the secret
          minLength: 1
          maxLength: 255
        secret_value:
          type: string
          description: New secret value (API key, token, etc.)
          minLength: 1

    SecretResponse:
      type: object
      required:
        - id
        - name
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the secret
        name:
          type: string
          description: User-provided label for the secret
        provider:
          type: string
          description: Provider identifier (e.g., huggingface, civitai)
        last_used_at:
          type: string
          format: date-time
          description: When the secret was last used for decryption
        created_at:
          type: string
          format: date-time
          description: When the secret was created
        updated_at:
          type: string
          format: date-time
          description: When the secret was last updated

    SecretListResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/SecretResponse'

    PlanAvailability:
      type: object
      required:
        - available
      properties:
        available:
          type: boolean
          description: Whether the workspace can subscribe to this plan
        reason:
          $ref: '#/components/schemas/PlanAvailabilityReason'

    PlanAvailabilityReason:
      type: string
      enum:
        - same_plan
        - incompatible_transition
        - requires_team
        - requires_personal
        - exceeds_max_seats
      description: Reason why a plan is unavailable

    Plan:
      type: object
      required:
        - slug
        - tier
        - duration
        - price_cents
        - credits_cents
        - max_seats
        - availability
        - seat_summary
      properties:
        slug:
          type: string
          description: Plan identifier (e.g., "pro-monthly", "team-standard-annual")
          example: "pro-monthly"
        tier:
          $ref: '#/components/schemas/SubscriptionTier'
        duration:
          $ref: '#/components/schemas/SubscriptionDuration'
        price_cents:
          type: integer
          format: int64
          description: Per-member price in cents (base + one seat)
          example: 10000
        credits_cents:
          type: integer
          format: int64
          description: Per-member credits in cents (base + one seat)
          example: 10000
        max_seats:
          type: integer
          format: int64
          description: Maximum number of seats allowed for this plan
          example: 20
        availability:
          $ref: '#/components/schemas/PlanAvailability'
        seat_summary:
          $ref: '#/components/schemas/PlanSeatSummary'

    PlanSeatSummary:
      type: object
      description: Summary of seat costs based on current workspace members
      required:
        - seat_count
        - total_cost_cents
        - total_credits_cents
      properties:
        seat_count:
          type: integer
          description: Total number of seats (owner + members) that would be charged
          example: 5
        total_cost_cents:
          type: integer
          format: int64
          description: Total cost for all seats in cents
          example: 50000
        total_credits_cents:
          type: integer
          format: int64
          description: Total credits granted for all seats in cents
          example: 50000

    BillingPlansResponse:
      type: object
      required:
        - plans
      properties:
        current_plan_slug:
          type: string
          description: Current plan slug if subscribed
        plans:
          type: array
          items:
            $ref: '#/components/schemas/Plan'

    PreviewSubscribeRequest:
      type: object
      required:
        - plan_slug
      properties:
        plan_slug:
          type: string
          description: Target plan slug to preview subscribing to
          example: "team-pro-monthly"

    PreviewSubscribeResponse:
      type: object
      required:
        - allowed
        - transition_type
        - effective_at
        - is_immediate
        - cost_today_cents
        - cost_next_period_cents
        - credits_today_cents
        - credits_next_period_cents
        - new_plan
      properties:
        allowed:
          type: boolean
          description: Whether this subscription change is allowed
        reason:
          type: string
          description: Reason why the change is not allowed (only present if allowed=false)
        transition_type:
          type: string
          enum: [new_subscription, upgrade, downgrade, duration_change]
          description: Type of subscription transition
        effective_at:
          type: string
          format: date-time
          description: When the change takes effect
        is_immediate:
          type: boolean
          description: Whether the change takes effect immediately (true) or at period end (false)
        cost_today_cents:
          type: integer
          format: int64
          description: Amount to charge today in cents (0 for downgrades)
          example: 5000
        cost_next_period_cents:
          type: integer
          format: int64
          description: Amount that will be charged at next billing period in cents
          example: 10000
        credits_today_cents:
          type: integer
          format: int64
          description: Credits granted today in cents (prorated for mid-period upgrades)
          example: 5000
        credits_next_period_cents:
          type: integer
          format: int64
          description: Credits that will be granted at next billing period in cents
          example: 10000
        current_plan:
          $ref: '#/components/schemas/PreviewPlanInfo'
        new_plan:
          $ref: '#/components/schemas/PreviewPlanInfo'

    PreviewPlanInfo:
      type: object
      description: Plan information for preview display
      required:
        - slug
        - tier
        - duration
        - price_cents
        - credits_cents
        - seat_summary
      properties:
        slug:
          type: string
          description: Plan slug
          example: "team-pro-monthly"
        tier:
          $ref: '#/components/schemas/SubscriptionTier'
        duration:
          $ref: '#/components/schemas/SubscriptionDuration'
        price_cents:
          type: integer
          format: int64
          description: Per-seat price in cents
          example: 10000
        credits_cents:
          type: integer
          format: int64
          description: Per-seat credits in cents
          example: 10000
        seat_summary:
          $ref: '#/components/schemas/PlanSeatSummary'
        period_start:
          type: string
          format: date-time
          description: Current billing period start (only for current_plan)
        period_end:
          type: string
          format: date-time
          description: Current billing period end (only for current_plan)

    SubscribeRequest:
      type: object
      required:
        - plan_slug
      properties:
        plan_slug:
          type: string
          description: Target plan slug to subscribe to
          example: "team-pro-monthly"
        idempotency_key:
          type: string
          description: |
            Client-provided key to prevent duplicate operations.
            If a billing op with this key already exists, returns the existing op instead of creating a new one.
          example: "sub-abc123-1234567890"
        return_url:
          type: string
          description: |
            URL to redirect after payment method is added successfully.
            Required if workspace has no payment method on file.
          example: "https://cloud.comfy.org/billing/success"
        cancel_url:
          type: string
          description: |
            URL to redirect if user cancels the payment method flow.
            If not provided, return_url is used for both success and cancel.
          example: "https://cloud.comfy.org/billing"

    SubscribeResponse:
      type: object
      required:
        - status
        - billing_op_id
      properties:
        billing_op_id:
          type: string
          description: Billing operation ID to poll for status via GET /api/billing/ops/{id}
        status:
          type: string
          enum: [subscribed, needs_payment_method, pending_payment]
          description: |
            Status of the subscription operation:
            - subscribed: Subscription is active immediately
            - needs_payment_method: User must add payment method via payment_method_url
            - pending_payment: Upgrade initiated, waiting for payment to complete
        effective_at:
          type: string
          format: date-time
          description: When the subscription became/becomes active (present when status=subscribed or pending_payment)
        payment_method_url:
          type: string
          description: URL to redirect user to add payment method (present when status=needs_payment_method)

    CancelSubscriptionRequest:
      type: object
      properties:
        idempotency_key:
          type: string
          description: |
            Client-provided key to prevent duplicate operations.
            If a billing op with this key already exists, returns the existing op instead of creating a new one.

    CancelSubscriptionResponse:
      type: object
      required:
        - cancel_at
        - billing_op_id
      properties:
        billing_op_id:
          type: string
          description: Billing operation ID to poll for status via GET /api/billing/ops/{id}
        cancel_at:
          type: string
          format: date-time
          description: The date when the subscription will end (end of current billing period)

    ResubscribeRequest:
      type: object
      properties:
        idempotency_key:
          type: string
          description: |
            Client-provided key to prevent duplicate operations.
            If a billing op with this key already exists, returns the existing op instead of creating a new one.

    ResubscribeResponse:
      type: object
      required:
        - status
        - billing_op_id
      properties:
        billing_op_id:
          type: string
          description: Billing operation ID to poll for status via GET /api/billing/ops/{id}
        status:
          type: string
          enum: [active]
          description: The subscription status after resubscribing
        message:
          type: string
          description: Human-readable confirmation message

    PaymentPortalRequest:
      type: object
      properties:
        return_url:
          type: string
          description: URL to redirect after the user exits the portal

    PaymentPortalResponse:
      type: object
      required:
        - url
      properties:
        url:
          type: string
          description: Stripe Billing Portal URL

    CreateTopupRequest:
      type: object
      required:
        - amount_cents
      properties:
        amount_cents:
          type: integer
          format: int64
          minimum: 500
          description: Amount to charge and grant as credits (in cents). Minimum $5.00.
        idempotency_key:
          type: string
          description: |
            Client-provided key to prevent duplicate operations.
            If a billing op with this key already exists, returns the existing op instead of creating a new one.

    CreateTopupResponse:
      type: object
      required:
        - topup_id
        - status
        - amount_cents
        - billing_op_id
      properties:
        billing_op_id:
          type: string
          description: Billing operation ID to poll for status via GET /api/billing/ops/{id}
        topup_id:
          type: string
          description: Unique identifier for the top-up request (same as billing_op_id, deprecated)
        status:
          type: string
          enum: [pending, completed, failed]
          description: Current status of the top-up
        amount_cents:
          type: integer
          format: int64
          description: Amount being charged in cents

    TopupStatusResponse:
      type: object
      required:
        - topup_id
        - status
        - amount_cents
        - created_at
      properties:
        topup_id:
          type: string
          description: Unique identifier for the top-up request
        status:
          type: string
          enum: [pending, completed, failed]
          description: Current status of the top-up
        amount_cents:
          type: integer
          format: int64
          description: Amount charged in cents
        error_message:
          type: string
          description: Error message if status is failed
        created_at:
          type: string
          format: date-time
          description: When the top-up was initiated
        completed_at:
          type: string
          format: date-time
          description: When the top-up completed (success or failure)

    BillingOpStatusResponse:
      type: object
      required:
        - id
        - status
        - started_at
      properties:
        id:
          type: string
          description: Unique identifier for the billing operation
        status:
          type: string
          enum: [pending, succeeded, failed]
          description: Current status of the operation
        error_message:
          type: string
          description: Error message if status is failed
        started_at:
          type: string
          format: date-time
          description: When the operation was initiated
        completed_at:
          type: string
          format: date-time
          description: When the operation completed (success or failure)